<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <title>Panel del Productor ‚Äî RuralControl</title>

  <style>
    /* ‚úÖ Responsive base */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f3f4f6;
    }

    header {
      background: #14532d;
      color: white;
      padding: 16px;
      text-align: center;
    }

    .container {
      padding: 20px;
      max-width: 1000px;
      margin: auto;
      width: 100%;
    }

    h2 {
      margin-top: 25px;
      color: #14532d;
      font-weight: 800;
      position: relative;
      padding-bottom: 6px;
      display: inline-block;
    }

    h2::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      width: 35%;
      height: 3px;
      background: #14532d;
      border-radius: 3px;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 25px rgba(0, 0, 0, .10);
    }


    .fila {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    input,
    select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      flex: 1;
      min-width: 220px;
    }

    .btn-primario {
      background: #14532d;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-secundario {
      background: #e5e7eb;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-mini {
      margin-top: 10px;
      background: #7f1d1d;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .lista-simple {
      margin-top: 15px;
    }

    /* Tarjetas elevadas estilo app */
    .item-simple {
      background: white;
      padding: 14px;
      border-radius: 14px;
      margin-bottom: 14px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      transition: transform .12s ease, box-shadow .12s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .item-simple:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .item-simple .item-info {
      min-width: 0;
    }

    /* ========================================================= */
    /* CHIPS MODERNOS PARA FILTROS */
    /* ========================================================= */
    .filtro-chip {
      background: #e5e7eb;
      padding: 6px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      border: 1px solid #d1d5db;
      transition: all 0.2s ease;
      user-select: none;
    }

    .filtro-chip:hover {
      background: #d1d5db;
    }

    .filtro-chip.activo {
      background: #14532d;
      color: white;
      border-color: #14532d;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .chip-categoria {
      background: #d1fae5;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
    }

    .chip-prioridad-alta {
      background: #fecaca;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
    }

    .chip-prioridad-media {
      background: #fef08a;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
    }

    .chip-prioridad-baja {
      background: #bbf7d0;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
    }

    .status-msg {
      margin-top: 10px;
      font-size: 14px;
    }

    /* ==================================== */
    /* NAV AVANZADO ESTILO APP */
    /* ==================================== */

    .nav-panel {
      display: flex;
      overflow-x: auto;
      padding: 8px;
      gap: 10px;
      background: #eaf2ec;
      border-bottom: 1px solid #d1d5db;
    }

    .nav-btn {
      flex: 1;
      min-width: 120px;
      background: #14532d;
      color: white;
      border: none;
      padding: 12px 0;
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      position: relative;
      transition: all 0.25s ease;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
    }

    .nav-btn .icono {
      font-size: 20px;
      transition: transform 0.2s ease;
    }

    .nav-btn .texto {
      font-size: 14px;
      font-weight: bold;
    }

    .nav-btn .indicador {
      position: absolute;
      bottom: -5px;
      width: 0px;
      height: 4px;
      background: #1e7a42;
      border-radius: 4px;
      transition: width 0.25s ease;
    }

    .nav-btn.activo {
      background: #1e7a42;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .nav-btn.activo .icono {
      transform: scale(1.25);
    }

    .nav-btn.activo .indicador {
      width: 40%;
    }

    .hidden {
      display: none;
    }

    section {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .25s ease, transform .25s ease;
    }

    section.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .tooltip-camino {
      background: white;
      border: 1px solid #d1d5db;
      padding: 4px 8px;
      border-radius: 8px;
      color: #111827;
      font-size: 12px;
      font-weight: bold;
    }

    #mapCaminos,
    #mapMarcaciones {
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.12);
      border: 1px solid #d1d5db;
    }

    .leaflet-popup-content {
      font-size: 14px;
      line-height: 18px;
    }

    .leaflet-popup-content-wrapper {
      border-radius: 12px;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
    }

    .leaflet-popup-tip {
      background: white;
      border: 1px solid #d1d5db;
    }

    /* NAV: botones un poco m√°s chicos en pantallas medianas */
    @media (max-width: 900px) {
      header {
        padding: 12px;
      }

      .container {
        padding: 14px;
      }

      .nav-btn {
        min-width: 105px;
        padding: 10px 0;
      }

      .nav-btn .texto {
        font-size: 13px;
      }
    }

    /* M√≥vil */
    @media (max-width: 600px) {
      header h1 {
        font-size: 18px;
      }

      .container {
        padding: 12px;
      }

      .fila {
        flex-direction: column;
        gap: 8px;
      }

      input,
      select {
        width: 100%;
        min-width: 0;
      }

      .btn-primario,
      .btn-secundario,
      .btn-mini {
        width: 100%;
      }

      .item-simple {
        flex-direction: column;
        align-items: flex-start;
      }

      .item-simple a.btn-primario,
      .item-simple button.btn-secundario {
        width: 100%;
        text-align: center;
      }

      #mapCaminos,
      #mapMarcaciones {
        height: 240px !important;
      }
    }

    @media (max-width: 380px) {
      .nav-btn {
        min-width: 95px;
      }

      .nav-btn .icono {
        font-size: 18px;
      }

      .nav-btn .texto {
        font-size: 12px;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>Panel del Productor</h1>
  </header>

  <!-- NAV -->
  <nav class="nav-panel">
    <button data-target="sec-empleados" class="nav-btn activo">
      <span class="icono">üë∑</span>
      <span class="texto">Empleados</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-marcaciones-locales" class="nav-btn">
      <span class="icono">üìå</span>
      <span class="texto">Locales</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-camiones" class="nav-btn">
      <span class="icono">üöö</span>
      <span class="texto">Camiones</span>
      <div class="indicador"></div>
    </button>


    <button data-target="sec-marcaciones-online" class="nav-btn">
      <span class="icono">üìç</span>
      <span class="texto">Online</span>
      <div class="indicador"></div>
    </button>



    <button data-target="sec-caminos" class="nav-btn">
      <span class="icono">üõ£Ô∏è</span>
      <span class="texto">Caminos</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-vecinos" class="nav-btn">
      <span class="icono">ü§ù</span>
      <span class="texto">Vecinos</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-alertas" class="nav-btn">
      <span class="icono">üö®</span>
      <span class="texto">Alertas</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-tareas" class="nav-btn">
      <span class="icono">üìù</span>
      <span class="texto">Tareas</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-calculadora" class="nav-btn">
      <span class="icono">üßÆ</span>
      <span class="texto">Calculadora</span>
      <div class="indicador"></div>
    </button>


  </nav>

  <div class="container">

    <!-- ============================= -->
    <!-- SECCI√ìN: EMPLEADOS -->
    <!-- ============================= -->
    <section id="sec-empleados" class="visible">
      <h2>Gesti√≥n de empleados</h2>
      <small>Registr√° los empleados que trabajan en tu establecimiento.</small>

      <div class="fila" style="margin-top:15px;">
        <input type="text" id="empNombre" placeholder="Nombre del empleado">
        <input type="text" id="empDni" placeholder="DNI">
        <input type="text" id="empTelefono" placeholder="Tel√©fono (WhatsApp)">
        <input type="text" id="empClave" placeholder="Clave de acceso">
        <button class="btn-primario" id="btnAgregarEmpleado">‚ûï Agregar</button>
      </div>

      <p class="status-msg" id="msgEmpleado"></p>
      <div id="listaEmpleados" class="lista-simple"></div>
    </section>



    <!-- ============================= -->
    <!-- SECCI√ìN: MARCACIONES LOCALES -->
    <!-- ============================= -->
    <section id="sec-marcaciones-locales" class="hidden">
      <h2>Marcaciones del d√≠a (modo local)</h2>
      <small>Se registran solo en este dispositivo.</small>

      <p id="msgMarcLocal" class="status-msg"></p>
      <div id="listaMarcLocal" class="lista-simple"></div>

      <button class="btn-mini" id="btnBorrarMarcLocal">üóë Borrar marcaciones locales</button>
    </section>

    <!-- ============================= -->
    <!-- SECCI√ìN: MARCACIONES ONLINE -->
    <!-- ============================= -->
    <section id="sec-marcaciones-online" class="hidden">
      <h2>Marcaciones online</h2>
      <small>Se registran en tiempo real v√≠a GPS.</small>

      <div id="mapMarcaciones" style="width:100%; height:300px; margin-top:15px; border-radius:10px; background:#ddd;">
      </div>

      <p class="status-msg" id="msgMarcOnline"></p>
      <div id="listaMarcOnline" class="lista-simple"></div>
    </section>




    <!-- ============================= -->
    <!-- SECCI√ìN: CAMIONES (TRACKING) -->
    <!-- ============================= -->
    <section id="sec-camiones" class="hidden">
      <h2>Monitoreo de camiones</h2>
      <small>Ubicaci√≥n en tiempo real del chofer (celular) con GPS.</small>

      <div id="mapCamiones" style="width:100%; height:330px; margin-top:15px; background:#ddd; border-radius:10px;">
      </div>

      <p class="status-msg" id="msgCamiones"></p>
      <div id="listaCamiones" class="lista-simple"></div>
    </section>


    <!-- ============================= -->
    <!-- SECCI√ìN: VECINOS -->
    <!-- ============================= -->
    <section id="sec-vecinos" class="hidden">
      <h2>Vecinos de la zona</h2>
      <small>Agreg√° contactos de confianza cerca de tu campo.</small>

      <div class="fila">
        <input type="text" id="vecinoNombre" placeholder="Nombre del vecino">
        <input type="text" id="vecinoTelefono" placeholder="Tel√©fono">
        <button class="btn-primario" id="btnAgregarVecino">‚ûï Agregar</button>
      </div>

      <p class="status-msg" id="msgVecinos"></p>
      <div id="listaVecinos" class="lista-simple"></div>
    </section>

    <!-- ============================= -->
    <!-- SECCI√ìN: ALERTAS -->
    <!-- ============================= -->
    <section id="sec-alertas" class="hidden">
      <h2>Alertas rurales</h2>
      <small>Envi√° alertas r√°pidas a tus empleados.</small>

      <div class="fila">
        <select id="alertaTipo">
          <option value="Vehiculo Sospechoso">üö®Vehiculo Sospechoso</option>
          <option value="Animal perdido">üêÑ Animales perdido</option>
          <option value="Incendio">üî• Incendio</option>
          <option value="Aver√≠a">üõ† Aver√≠a</option>
          <option value="Otro">üì¶ Otro</option>
        </select>

        <input type="text" id="alertaDescripcion" placeholder="Descripci√≥n">
        <button class="btn-primario" id="btnEnviarAlerta">üì¢ Enviar</button>
      </div>

      <p class="status-msg" id="msgAlertas"></p>
      <div id="listaAlertas" class="lista-simple"></div>

      <!-- ‚úÖ Selecci√≥n visual de vecinos para enviar alerta -->
      <div style="margin-top:14px;">
        <h3 style="margin:10px 0 6px; color:#14532d;">üì≤ Enviar a vecinos</h3>

        <div class="fila" style="margin-top:6px;">
          <button class="btn-secundario" id="btnSelTodosVecinos" type="button">Seleccionar todos</button>
          <button class="btn-secundario" id="btnSelNingunoVecinos" type="button">Ninguno</button>
        </div>

        <div id="listaVecinosAlertas" class="lista-simple"></div>

        <small style="display:block;margin-top:8px;color:#6b7280;">

        </small>
      </div>

    </section>

    <!-- ============================= -->
    <!-- SECCI√ìN: CAMINOS -->
    <!-- ============================= -->
    <section id="sec-caminos" style="position:relative;" class="hidden">
      <h2>Estado de caminos</h2>
      <small>Pod√©s marcar puntos o tramos completos en el mapa.</small>

      <div class="fila" style="margin-top:10px;">
        <select id="caminoEstado">
          <option value="transitable">üü¢ Transitable</option>
          <option value="complicado">üü° Complicado</option>
          <option value="intransitable">üî¥ Intransitable</option>
        </select>

        <span id="estadoPreview" style="
          padding:6px 10px;
          border-radius:10px;
          font-weight:bold;
          background:#e5e7eb;
          color:#111;
        "></span>

        <button class="btn-primario" id="btnModoPunto">Marcar punto</button>
        <button class="btn-secundario" id="btnModoTramo">Marcar tramo</button>
        <button class="btn-primario" id="btnGuardarTramo" style="display:none;">Guardar tramo</button>
        <button class="btn-secundario" id="btnCentrarUbicacion">üìç Centrar en mi ubicaci√≥n</button>

      </div>

      <div class="fila" style="margin-top:10px; gap:8px;">
        <div class="filtro-chip" id="filtroTodos">Todos</div>
        <div class="filtro-chip" id="filtroTransitable">üü¢ Transitable</div>
        <div class="filtro-chip" id="filtroComplicado">üü° Complicado</div>
        <div class="filtro-chip" id="filtroIntransitable">üî¥ Intransitable</div>

        <button class="btn-mini" id="btnBorrarMisCaminosHoy">üóë Mis caminos de hoy</button>
      </div>

      <div id="mapCaminos" style="width:100%; height:330px; margin-top:15px; background:#ddd; border-radius:10px;">
      </div>

      <div id="leyendaCaminos" style="
        position:absolute;
        bottom:25px; right:10px;
        background:white;
        padding:8px 12px;
        border-radius:10px;
        border:1px solid #d1d5db;
        font-size:13px;
        box-shadow:0px 2px 6px rgba(0,0,0,0.15);
        line-height:18px;
      ">
        <div>üü¢ Transitable</div>
        <div>üü° Complicado</div>
        <div>üî¥ Intransitable</div>
      </div>

      <p id="msgCaminos" class="status-msg"></p>
    </section>

    <!-- ============================= -->
    <!-- SECCI√ìN: TAREAS -->
    <!-- ============================= -->
    <section id="sec-tareas" class="hidden">
      <h2>Registro de tareas diarias</h2>
      <small>Carg√° las tareas del d√≠a y marc√° cu√°les se completaron.</small>

      <div class="fila">
        <input type="text" id="nuevaTareaTexto" placeholder="Ej: Revisar bebederos del potrero 3" />

        <select id="tareaCategoria">
          <option value="Ganader√≠a">üêÑ Ganader√≠a</option>
          <option value="Cultivos">üåΩ Cultivos</option>
          <option value="Maquinaria">üöú Maquinaria</option>
          <option value="Mantenimiento">üõ† Mantenimiento</option>
          <option value="Seguridad">üö® Seguridad</option>
          <option value="Limpieza">üßπ Limpieza</option>
          <option value="Otros">üì¶ Otros</option>
        </select>

        <select id="tareaPrioridad">
          <option value="Alta">üî¥ Alta</option>
          <option value="Media">üü° Media</option>
          <option value="Baja">üü¢ Baja</option>
        </select>

        <select id="tareaEmpleado">
          <option value="">(sin asignar)</option>
        </select>

        <button class="btn-primario" id="btnAgregarTarea">‚ûï Agregar</button>
      </div>

      <p class="status-msg" id="msgTareas"></p>
      <div id="listaTareas" class="lista-simple"></div>

      <button class="btn-mini" id="btnBorrarTareas">üóë Borrar tareas locales</button>
    </section>

    <!-- ============================= -->
    <!-- SECCI√ìN: CALCULADORA -->
    <!-- ============================= -->
    <section id="sec-calculadora" class="hidden">
      <h2>Calculadora agropecuaria</h2>
      <small>Herramientas r√°pidas para campo (fertilizaci√≥n y m√°s).</small>

      <!-- 1) kg/ha ‚Üí total -->
      <div class="card" style="margin-top:14px;">
        <h3 id="agroTitulo" style="margin:0 0 8px; color:#14532d;">üß™ Fertilizante total (por ha ‚Üí total)</h3>


        <div class="fila">
          <input id="calcHa" type="number" step="0.01" placeholder="Hect√°reas (ej: 25.5)">
          <input id="calcKgHa" type="number" step="0.1" placeholder="Dosis por ha (ej: 120)">

          <select id="agroUnidad">
            <option value="kg">Kg/ha</option>
            <option value="l">L/ha</option>
          </select>

          <button class="btn-primario" id="btnCalcTotal">Calcular</button>
          <button class="btn-secundario" id="btnCalcTotalClear" type="button">Limpiar</button>
             <p class="status-msg" id="resCalcTotal"></p>
        </div>


        <!-- 2) N requerido ‚Üí Urea -->
        <div class="card" style="margin-top:14px;">
          <h3 style="margin:0 0 8px; color:#14532d;">üåø Nitr√≥geno ‚Üí Urea (46% N)</h3>
          <div class="fila">
            <input id="calcNkg" type="number" step="0.1" placeholder="N requerido (kg de N total)">
            <button class="btn-primario" id="btnCalcUrea">Calcular</button>
            <button class="btn-secundario" id="btnCalcUreaClear" type="button">Limpiar</button>
          </div>
          <p class="status-msg" id="resCalcUrea"></p>

          <small style="display:block;color:#6b7280;margin-top:6px;">
            F√≥rmula: Urea (kg) = N (kg) / 0.46
          </small>
        </div>

        <!-- 3) GANADER√çA: Consumo Materia Seca -->
        <div class="card" style="margin-top:14px;">
          <h3 style="margin:0 0 8px; color:#14532d;">üêÑ Ganader√≠a: Consumo de Materia Seca</h3>
          <div class="fila">
            <input id="ganPeso" type="number" step="0.1" placeholder="Peso vivo (kg) ej: 380">
            <input id="ganPorcMS" type="number" step="0.1" placeholder="% MS del PV ej: 2.5">
            <input id="ganCabezas" type="number" step="1" placeholder="Cantidad de animales ej: 120">
          </div>

          <div class="fila">
            <button class="btn-primario" id="btnCalcMS">Calcular</button>
            <button class="btn-secundario" id="btnCalcMSClear" type="button">Limpiar</button>
          </div>

          <p class="status-msg" id="resCalcMS"></p>

          <small style="display:block;color:#6b7280;margin-top:6px;">
            F√≥rmulas: MS/d√≠a/cab = PV * (%MS/100) ‚Ä¢ Total/d√≠a = MS/cab * cabezas ‚Ä¢ Mes = Total/d√≠a * 30
          </small>
        </div>

    </section>


  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { auth, db } from "../firebase-init.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, query, where, onSnapshot, orderBy,
      doc, setDoc, updateDoc, deleteDoc, writeBatch, serverTimestamp,
      getDocs, addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


    let productorId = null;

    // =========================
    // 1) GATE POR AUTH
    // =========================
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("Debes iniciar sesi√≥n como Productor.");
        window.location.href = "login.html";
        return;
      }

      productorId = user.uid;
      localStorage.setItem("productorId", productorId);

      iniciarPanel();
    });

    // =========================
    // 2) NAVEGACI√ìN ENTRE SECCIONES
    // =========================
    function navegar() {
      const botones = document.querySelectorAll(".nav-btn");
      const secciones = document.querySelectorAll("section");

      botones.forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.target;

          botones.forEach(b => b.classList.remove("activo"));
          btn.classList.add("activo");

          secciones.forEach(sec => {
            if (sec.id === target) {
              sec.classList.remove("hidden");
              setTimeout(() => sec.classList.add("visible"), 10);
            } else {
              sec.classList.remove("visible");
              setTimeout(() => sec.classList.add("hidden"), 150);
            }
          });

          // Mapas
          if (target === "sec-marcaciones-online") {
            setTimeout(() => {
              initMapaMarcaciones();
              actualizarMarcacionesMapa();
              if (mapaMarcaciones) mapaMarcaciones.invalidateSize();
            }, 200);
          }

          if (target === "sec-caminos") {
            setTimeout(() => {
              initMapaCaminos();
              if (mapaCaminos) mapaCaminos.invalidateSize();
            }, 200);
          }

          if (target === "sec-camiones") {
            setTimeout(() => {
              initMapaCamiones();
              if (mapaCamiones) mapaCamiones.invalidateSize();
            }, 200);
          }

        });
      });

      // estado inicial
      secciones.forEach(sec => sec.classList.add("hidden"));
      const primera = document.getElementById("sec-empleados");
      primera.classList.remove("hidden");
      primera.classList.add("visible");
    }

    navegar();

    // =========================
    // 3) INICIO DEL PANEL
    // =========================
    function iniciarPanel() {
      cargarEmpleados();
      escucharTareas();
      escucharMarcacionesOnline();
      escucharVecinos();
      escucharVecinosParaAlertas();
      escucharAlertas();

      // ‚úÖ AHORA s√≠ (porque ya existe la funci√≥n global)
      escucharCamiones();
      initCalculadora();


      setTimeout(() => {
        initMapaMarcaciones();
        initMapaCaminos();
      }, 300);

      setTimeout(() => marcarChipActivo("filtroTodos"), 350);

      document.getElementById("caminoEstado").dispatchEvent(new Event("change"));
    }



    /* ============================================================
   üöö CAMIONES (TRACKING REALTIME)
============================================================ */
    let mapaCamiones = null;
    let capaCamiones = null;
    const markersCamiones = new Map(); // camionId -> marker

    function initMapaCamiones() {
      // ‚úÖ si el div no est√°, salimos sin romper
      const mapDiv = document.getElementById("mapCamiones");
      if (!mapDiv) return;

      if (mapaCamiones) return;
      mapaCamiones = L.map("mapCamiones").setView([-33, -59.3], 10);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaCamiones);
      capaCamiones = L.layerGroup().addTo(mapaCamiones);
    }

    function renderCamionItem(c) {
      const upd = c.lastSeen ? new Date(c.lastSeen).toLocaleString("es-AR") : "‚Äî";
      const onlineTxt = c.online ? "üü¢ Online" : "üî¥ Offline";
      const accTxt = (c.accuracy != null) ? `‚Ä¢ ¬±${c.accuracy}m` : "";
      return `
    <div class="item-simple">
      <div class="item-info">
        <strong>üöö ${c.camionId ?? "(sin ID)"}</strong><br>
        <small>Chofer DNI: ${c.empleadoDni ?? "‚Äî"}</small><br>
        <small>${onlineTxt} ‚Ä¢ √öltimo ping: ${upd} ${accTxt}</small>
      </div>
      <button class="btn-secundario" data-zoom="${c.camionId ?? ""}">Ver</button>
    </div>
  `;
    }

    function upsertMarkerCamion(c) {
      if (!mapaCamiones || !capaCamiones) return;

      const camionId = c.camionId;
      if (!camionId) return;

      if (typeof c.lat !== "number" || typeof c.lng !== "number") return;

      const popup = `
    <b>üöö ${camionId}</b><br>
    Chofer: ${c.empleadoDni ?? "‚Äî"}<br>
    Estado: ${c.online ? "üü¢ Online" : "üî¥ Offline"}<br>
    Precisi√≥n: ${c.accuracy ?? "‚Äî"} m
  `;

      if (markersCamiones.has(camionId)) {
        const m = markersCamiones.get(camionId);
        m.setLatLng([c.lat, c.lng]);
        m.setPopupContent(popup);
      } else {
        const m = L.marker([c.lat, c.lng]).addTo(capaCamiones);
        m.bindPopup(popup);
        markersCamiones.set(camionId, m);
      }
    }

    function limpiarMarkersNoPresentes(setIdsActuales) {
      for (const [id, marker] of markersCamiones.entries()) {
        if (!setIdsActuales.has(id)) {
          capaCamiones.removeLayer(marker);
          markersCamiones.delete(id);
        }
      }
    }

    function escucharCamiones() {
      if (!productorId) return;

      const msgCamiones = document.getElementById("msgCamiones");
      const listaCamiones = document.getElementById("listaCamiones");

      // ‚úÖ Guard: si no existe la secci√≥n, no rompas
      if (!msgCamiones || !listaCamiones) {
        console.warn("Faltan elementos de Camiones (msgCamiones/listaCamiones).");
        return;
      }

      const qC = query(collection(db, "camiones"), where("productorId", "==", productorId));

      onSnapshot(qC, (snap) => {
        initMapaCamiones();

        listaCamiones.innerHTML = "";
        msgCamiones.style.color = "#4b5563";

        if (snap.empty) {
          msgCamiones.textContent = "No hay camiones transmitiendo todav√≠a.";
          if (capaCamiones) capaCamiones.clearLayers();
          markersCamiones.clear();
          return;
        }

        const idsActuales = new Set();
        const camiones = [];

        snap.forEach((d) => {
          const c = d.data();
          camiones.push(c);
          if (c.camionId) idsActuales.add(c.camionId);
          upsertMarkerCamion(c);
        });

        limpiarMarkersNoPresentes(idsActuales);

        camiones
          .sort((a, b) => (b.lastSeen || 0) - (a.lastSeen || 0))
          .forEach((c) => {
            listaCamiones.innerHTML += renderCamionItem(c);
          });

        msgCamiones.textContent = `Camiones encontrados: ${camiones.length}`;

        listaCamiones.querySelectorAll("button[data-zoom]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-zoom");
            const marker = markersCamiones.get(id);
            if (!marker) return;
            mapaCamiones.setView(marker.getLatLng(), 16, { animate: true });
            marker.openPopup();
          });
        });

      }, (err) => {
        console.error("Snapshot camiones:", err);
        msgCamiones.style.color = "#b91c1c";
        msgCamiones.textContent = "Error escuchando camiones (permisos/reglas/√≠ndices).";
      });
    }

    /* ============================================================
       EMPLEADOS (FIREBASE)
    ============================================================ */
    const msgEmpleado = document.getElementById("msgEmpleado");
    const listaEmpleados = document.getElementById("listaEmpleados");

    async function cargarEmpleados() {
      if (!productorId) return;

      listaEmpleados.innerHTML = "<small>Cargando...</small>";

      const ref = collection(db, "employees");
      const q = query(ref, where("productorId", "==", productorId));
      const snap = await getDocs(q);

      listaEmpleados.innerHTML = "";
      if (snap.empty) {
        listaEmpleados.innerHTML = "<small>No hay empleados cargados.</small>";
      }

      snap.forEach(s => {
        const e = s.data();
        const item = document.createElement("div");
        item.className = "item-simple";

        item.innerHTML = `
          <div class="item-info">
            <strong>üë∑ ${e.dni}</strong><br>
            <small>${e.nombre ?? ""}</small>
          </div>
          <span class="chip chip-verde">Activo</span>
        `;

        listaEmpleados.appendChild(item);
      });

      // cargar select tareas
      const sel = document.getElementById("tareaEmpleado");
      sel.innerHTML = `<option value="">(sin asignar)</option>`;
      snap.forEach(s => {
        const e = s.data();
        sel.innerHTML += `<option value="${e.dni}">${e.dni}</option>`;
      });
    }

    document.getElementById("btnAgregarEmpleado").addEventListener("click", async () => {
      const nombre = document.getElementById("empNombre").value.trim();
      const dni = document.getElementById("empDni").value.trim();
      const telefono = document.getElementById("empTelefono").value.trim();
      const clave = document.getElementById("empClave").value.trim();

      if (!nombre || !dni || !telefono || !clave) {
        msgEmpleado.textContent = "‚ö†Ô∏è Complet√° todos los campos (incluido tel√©fono).";
        msgEmpleado.style.color = "#b91c1c";
        return;
      }

      try {
        await setDoc(doc(db, "employees", dni), {
          productorId,
          nombre,
          dni,
          telefono,
          clave,
          activo: true,
          timestamp: serverTimestamp(),
          authUid: null
        });

        msgEmpleado.style.color = "#166534";
        msgEmpleado.textContent = "‚úÖ Empleado agregado.";

        document.getElementById("empNombre").value = "";
        document.getElementById("empDni").value = "";
        document.getElementById("empTelefono").value = "";
        document.getElementById("empClave").value = "";

        cargarEmpleados();
      } catch (e) {
        console.error(e);
        msgEmpleado.style.color = "#b91c1c";
        msgEmpleado.textContent = "‚ùå Error al registrar empleado.";
      }
    });

    /* ============================================================
       TAREAS
    ============================================================ */
    const listaTareas = document.getElementById("listaTareas");
    const msgTareas = document.getElementById("msgTareas");

    document.getElementById("btnAgregarTarea").addEventListener("click", agregarTarea);

    async function agregarTarea() {
      const texto = document.getElementById("nuevaTareaTexto").value.trim();
      const categoria = document.getElementById("tareaCategoria").value;
      const prioridad = document.getElementById("tareaPrioridad").value;
      const empleadoId = document.getElementById("tareaEmpleado").value || null;

      if (!texto) {
        msgTareas.textContent = "‚ö†Ô∏è Escrib√≠ la tarea.";
        msgTareas.style.color = "#b91c1c";
        return;
      }

      await addDoc(collection(db, "tareas"), {
        productorId,
        texto,
        categoria,
        prioridad,
        empleadoId,
        completada: false,
        timestamp: serverTimestamp()
      });

      document.getElementById("nuevaTareaTexto").value = "";
      msgTareas.style.color = "#166534";
      msgTareas.textContent = "‚úÖ Tarea guardada.";
    }

    function escucharTareas() {
      if (!productorId) return;
      const qT = query(collection(db, "tareas"), where("productorId", "==", productorId));

      onSnapshot(qT, snap => {
        listaTareas.innerHTML = "";
        if (snap.empty) {
          listaTareas.innerHTML = "<small>No hay tareas.</small>";
          return;
        }

        snap.forEach(docSnap => {
          const t = docSnap.data();

          const item = document.createElement("div");
          item.className = "item-simple";

          item.innerHTML = `
            <div class="item-info">
              <strong>${t.texto}</strong><br>
              <span class="chip-categoria">${t.categoria}</span>
              <span class="chip-prioridad-${t.prioridad.toLowerCase()}">${t.prioridad}</span><br>
              <small>Asignado a: ${t.empleadoId ?? "(sin asignar)"}</small><br>
              <small>${t.completada ? "‚úî Completada" : "Pendiente"}</small>
            </div>
          `;

          const btn = document.createElement("button");
          btn.className = "btn-secundario";
          btn.textContent = t.completada ? "Marcar pendiente" : "Marcar hecha";
          btn.addEventListener("click", async () => {
            await updateDoc(doc(db, "tareas", docSnap.id), {
              completada: !t.completada
            });
          });

          item.appendChild(btn);
          listaTareas.appendChild(item);
        });
      });
    }

    /* ============================================================
       MAPA MARCACIONES (simple)
    ============================================================ */
    let mapaMarcaciones = null;
    let capaMarcadores = null;
    let marcacionesOnline = [];

    function initMapaMarcaciones() {
      if (mapaMarcaciones) return;
      mapaMarcaciones = L.map("mapMarcaciones").setView([-33, -59.3], 10);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaMarcaciones);
      capaMarcadores = L.layerGroup().addTo(mapaMarcaciones);
      setTimeout(() => mapaMarcaciones.invalidateSize(), 400);
    }

    function actualizarMarcacionesMapa() {
      if (!mapaMarcaciones || !capaMarcadores) return;
      capaMarcadores.clearLayers();
      marcacionesOnline.forEach(m => {
        if (!m.lat || !m.lng) return;
        L.marker([m.lat, m.lng]).addTo(capaMarcadores);
      });
    }

    function escucharMarcacionesOnline() {
      if (!productorId) return;
      const qM = query(collection(db, "marcaciones"), where("productorId", "==", productorId));

      onSnapshot(qM, snap => {
        marcacionesOnline = [];

        snap.forEach(s => {
          const d = s.data();
          marcacionesOnline.push({
            lat: Number(d.lat),
            lng: Number(d.lng),
            fechaNum: d.timestamp?.seconds ?? 0,
            dni: d.dni,
            tipo: d.tipo
          });
        });

        actualizarMarcacionesMapa();
      });
    }

    /* ============================================================
       CAMINOS (Puntos + Tramos + Filtros + Alias)
    ============================================================ */
    let mapaCaminos = null;
    let modoCamino = "punto";
    let tramoActual = [];

    let capaTramos = null;
    let capaPuntosCaminos = null;

    let filtroEstado = "todos";
    let unsubscribeCaminos = null; // ‚úÖ evita listeners duplicados

    const coloresCamino = {
      transitable: "#16a34a",
      complicado: "#eab308",
      intransitable: "#dc2626"
    };

    // ===============================
    // üìç GPS: centrar mapa + arrancar donde est√°s
    // ===============================
    let miUbicacionMarker = null;

    function pedirUbicacionActual(opts = { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 }) {
      return new Promise((resolve, reject) => {
        if (!("geolocation" in navigator)) {
          reject(new Error("Geolocalizaci√≥n no disponible en este dispositivo."));
          return;
        }
        navigator.geolocation.getCurrentPosition(resolve, reject, opts);
      });
    }

    async function centrarEnMiUbicacion() {
      try {
        mostrarMensaje("üì° Buscando tu ubicaci√≥n...", "#14532d");

        const pos = await pedirUbicacionActual();
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = Math.round(pos.coords.accuracy || 0);

        if (!mapaCaminos) return;

        // mover el mapa
        mapaCaminos.setView([lat, lng], 15, { animate: true });

        // marcador de mi ubicaci√≥n (solo visual)
        if (miUbicacionMarker) {
          miUbicacionMarker.setLatLng([lat, lng]);
        } else {
          miUbicacionMarker = L.circleMarker([lat, lng], {
            radius: 8,
            weight: 2,
            color: "#111827",
            fillOpacity: 0.95
          }).addTo(mapaCaminos);

          miUbicacionMarker.bindPopup(`üìç Est√°s ac√°<br><small>Precisi√≥n aprox: ${acc} m</small>`);
        }

        mostrarMensaje("‚úÖ Ubicaci√≥n encontrada", "#166534");
      } catch (e) {
        console.error("GPS error:", e);
        mostrarMensaje("‚ùå No pude obtener tu ubicaci√≥n. Activ√° GPS y permisos.", "#b91c1c");
      }
    }


    function initMapaCaminos() {
      if (mapaCaminos) return;
      if (!productorId) return;

      mapaCaminos = L.map("mapCaminos").setView([-33, -59.3], 10);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaCaminos);

      capaTramos = L.layerGroup().addTo(mapaCaminos);
      capaPuntosCaminos = L.layerGroup().addTo(mapaCaminos);

      mapaCaminos.on("click", manejarClickMapa);

      cargarCaminosGuardados();
      setTimeout(() => mapaCaminos.invalidateSize(), 400);
    }

    // ‚úÖ intentar centrar autom√°ticamente al iniciar el mapa (si el usuario permite)
    setTimeout(() => centrarEnMiUbicacion(), 600);


    const btnModoPunto = document.getElementById("btnModoPunto");
    const btnModoTramo = document.getElementById("btnModoTramo");
    const btnGuardarTramo = document.getElementById("btnGuardarTramo");
    const btnCentrar = document.getElementById("btnCentrarUbicacion");
    if (btnCentrar) btnCentrar.onclick = () => centrarEnMiUbicacion();


    btnModoPunto.onclick = () => {
      modoCamino = "punto";
      btnGuardarTramo.style.display = "none";
      tramoActual = [];
      if (capaTramos) capaTramos.clearLayers();
    };

    btnModoTramo.onclick = () => {
      modoCamino = "tramo";
      tramoActual = [];
      btnGuardarTramo.style.display = "inline-block";
      if (capaTramos) capaTramos.clearLayers();
    };

    function manejarClickMapa(e) {
      const estado = document.getElementById("caminoEstado").value;
      const latlng = [e.latlng.lat, e.latlng.lng];

      if (modoCamino === "punto") guardarPunto(latlng, estado);
      if (modoCamino === "tramo") {
        tramoActual.push(latlng);
        dibujarTramoTemporal();
      }
    }

    async function guardarPunto(latlng, estado) {
      const alias = prompt("Nombre del lugar (opcional): ej. Puente, Entrada Potrero 3")?.trim() || "";

      try {
        await addDoc(collection(db, "caminos"), {
          productorId,
          tipo: "punto",
          estado,
          alias,
          lat: latlng[0],
          lng: latlng[1],
          fecha: Date.now(),
          timestamp: serverTimestamp()
        });

        mostrarMensaje("‚úÖ Punto guardado", "#166534");
      } catch (err) {
        console.error(err);
        mostrarMensaje("‚ùå Error al guardar el punto", "#b91c1c");
      }
    }

    btnGuardarTramo.onclick = async () => {
      const estado = document.getElementById("caminoEstado").value;

      if (tramoActual.length < 2) {
        mostrarMensaje("‚ö†Ô∏è Necesit√°s al menos 2 puntos para un tramo", "#b91c1c");
        return;
      }

      try {
        const alias = prompt("Nombre del tramo (opcional): ej. Camino al galp√≥n")?.trim() || "";

        await addDoc(collection(db, "caminos"), {
          productorId,
          tipo: "tramo",
          estado,
          alias,
          puntos: tramoActual,
          fecha: Date.now(),
          timestamp: serverTimestamp()
        });

        tramoActual = [];
        if (capaTramos) capaTramos.clearLayers();

        mostrarMensaje("‚úÖ Tramo guardado", "#166534");
      } catch (err) {
        console.error(err);
        mostrarMensaje("‚ùå Error al guardar tramo", "#b91c1c");
      }
    };

    function dibujarTramoTemporal() {
      if (!capaTramos) return;
      capaTramos.clearLayers();

      if (tramoActual.length >= 2) {
        L.polyline(tramoActual, {
          color: "#6b7280",
          weight: 3,
          dashArray: "6,4"
        }).addTo(capaTramos);
      }
    }

    function marcarChipActivo(id) {
      document.querySelectorAll(".filtro-chip").forEach(c => c.classList.remove("activo"));
      document.getElementById(id).classList.add("activo");
    }

    document.getElementById("filtroTodos").onclick = () => {
      filtroEstado = "todos";
      marcarChipActivo("filtroTodos");
      cargarCaminosGuardados();
    };
    document.getElementById("filtroTransitable").onclick = () => {
      filtroEstado = "transitable";
      marcarChipActivo("filtroTransitable");
      cargarCaminosGuardados();
    };
    document.getElementById("filtroComplicado").onclick = () => {
      filtroEstado = "complicado";
      marcarChipActivo("filtroComplicado");
      cargarCaminosGuardados();
    };
    document.getElementById("filtroIntransitable").onclick = () => {
      filtroEstado = "intransitable";
      marcarChipActivo("filtroIntransitable");
      cargarCaminosGuardados();
    };

    // ‚úÖ ESTA ES LA FUNCI√ìN CLAVE (corrigida)
    function cargarCaminosGuardados() {
      if (!productorId) return;
      if (!capaPuntosCaminos || !capaTramos) return;

      // ‚úÖ evita m√∫ltiples listeners cada vez que toc√°s un filtro
      if (typeof unsubscribeCaminos === "function") unsubscribeCaminos();

      const q = query(
        collection(db, "caminos"),
        where("productorId", "==", productorId)
      );

      unsubscribeCaminos = onSnapshot(q, (snap) => {
        capaPuntosCaminos.clearLayers();
        capaTramos.clearLayers();

        snap.forEach((docSnap) => {
          const d = docSnap.data();

          if (filtroEstado !== "todos" && d.estado !== filtroEstado) return;

          const color = coloresCamino[d.estado];
          const fechaTxt = new Date(d.fecha).toLocaleString("es-AR");

          if (d.tipo === "punto") {
            const marker = L.circleMarker([d.lat, d.lng], {
              radius: 9,
              color: "#1f2937",
              weight: 2,
              fillColor: color,
              fillOpacity: 0.95
            }).addTo(capaPuntosCaminos);

            const aliasTxt = d.alias ? `<b>üìç ${d.alias}</b><br>` : "";
            const titulo = d.alias ? `üìç ${d.alias}` : formaEstado(d.estado);

            marker.bindTooltip(titulo, {
              direction: "top",
              offset: [0, -12],
              opacity: 0.9,
              className: "tooltip-camino"
            });

            const latTxt = Number(d.lat).toFixed(6);
            const lngTxt = Number(d.lng).toFixed(6);
            const gmaps = `https://www.google.com/maps?q=${latTxt},${lngTxt}`;

            marker.bindPopup(`
              ${aliasTxt}
              <b>${formaEstado(d.estado)}</b><br>
              ${fechaTxt}<br>
              <small>Punto</small><br>
              <small><b>Coord:</b> ${latTxt}, ${lngTxt}</small><br><br>

              <button onclick="copiarCoord('${latTxt},${lngTxt}')">üìã Copiar coord</button>
              <a href="${gmaps}" target="_blank">üß≠ Abrir Maps</a>
              <br><br>

              <button onclick="cambiarEstadoCamino('${docSnap.id}')">Cambiar estado</button>
              <button onclick="borrarCamino('${docSnap.id}')">üóëÔ∏è Eliminar</button>

            `);
          }

          if (d.tipo === "tramo") {
            const poly = L.polyline(d.puntos, {
              color,
              weight: d.estado === "intransitable" ? 6 : d.estado === "complicado" ? 5 : 4,
              opacity: 0.9,
              dashArray: d.estado === "complicado" ? "6,4" : null
            }).addTo(capaTramos);

            const tituloTramo = d.alias ? `üõ£Ô∏è ${d.alias}` : formaEstado(d.estado);

            poly.bindTooltip(tituloTramo, {
              direction: "center",
              opacity: 0.9,
              className: "tooltip-camino"
            });

            const p0 = d.puntos?.[0];
            const p1 = d.puntos?.[d.puntos.length - 1];

            const ini = p0 ? `${Number(p0[0]).toFixed(6)}, ${Number(p0[1]).toFixed(6)}` : "-";
            const fin = p1 ? `${Number(p1[0]).toFixed(6)}, ${Number(p1[1]).toFixed(6)}` : "-";

            const distKm = calcularDistanciaTramoKM(d.puntos || []);
            const aliasTxt = d.alias ? `<b>üõ£Ô∏è ${d.alias}</b><br>` : "";

            poly.bindPopup(`
              ${aliasTxt}
              <b>${formaEstado(d.estado)}</b><br>
              ${fechaTxt}<br>
              <small>Tramo</small><br>
              <small><b>Inicio:</b> ${ini}</small><br>
              <small><b>Fin:</b> ${fin}</small><br>
              <small><b>Dist:</b> ${distKm.toFixed(2)} km</small><br><br>

              <button onclick="copiarCoord('${ini}')">üìã Copiar inicio</button>
              <button onclick="copiarCoord('${fin}')">üìã Copiar fin</button>
              <br><br>

              <button onclick="cambiarEstadoCamino('${docSnap.id}')">Cambiar estado</button>
            `);
          }
        });

      }, (err) => {
        console.error("Error escuchando caminos:", err);
        mostrarMensaje("‚ùå Sin permisos para leer caminos. Revis√° reglas Firestore.", "#b91c1c");
      });
    }

    function formaEstado(e) {
      return e === "transitable" ? "üü¢ Transitable"
        : e === "complicado" ? "üü° Complicado"
          : "üî¥ Intransitable";
    }

    function haversineKM(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function calcularDistanciaTramoKM(puntos) {
      if (!Array.isArray(puntos) || puntos.length < 2) return 0;
      let total = 0;
      for (let i = 1; i < puntos.length; i++) {
        const [lat1, lon1] = puntos[i - 1];
        const [lat2, lon2] = puntos[i];
        total += haversineKM(lat1, lon1, lat2, lon2);
      }
      return total;
    }

    // funciones globales para el popup
    window.cambiarEstadoCamino = async (id) => {
      const nuevo = prompt("Nuevo estado: transitable / complicado / intransitable");
      if (!["transitable", "complicado", "intransitable"].includes(nuevo)) {
        alert("Estado inv√°lido");
        return;
      }
      await updateDoc(doc(db, "caminos", id), { estado: nuevo });
    };

    window.borrarCamino = async (id) => {
      if (!confirm("¬øEliminar este punto/tramo de camino?")) return;
      try {
        await deleteDoc(doc(db, "caminos", id));
        mostrarMensaje("üóëÔ∏è Camino eliminado", "#b91c1c");
      } catch (e) {
        console.error("Error borrando camino:", e);
        alert("No se pudo eliminar (revis√° permisos/reglas).");
      }
    };


    window.copiarCoord = async (txt) => {
      try {
        await navigator.clipboard.writeText(txt);
        mostrarMensaje("‚úÖ Coordenadas copiadas: " + txt, "#166534");
      } catch (e) {
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        mostrarMensaje("‚úÖ Coordenadas copiadas: " + txt, "#166534");
      }
    };

    // borrar caminos de hoy (solo del productor)
    document.getElementById("btnBorrarMisCaminosHoy").onclick = async () => {
      if (!confirm("¬øBorrar SOLO tus caminos del d√≠a de hoy?")) return;

      const inicio = new Date();
      inicio.setHours(0, 0, 0, 0);
      const inicioMs = inicio.getTime();

      const q = query(
        collection(db, "caminos"),
        where("productorId", "==", productorId)
      );

      const snap = await getDocs(q);

      const batch = writeBatch(db);
      snap.forEach(docSnap => {
        const d = docSnap.data();
        if (d.fecha >= inicioMs) batch.delete(docSnap.ref);
      });

      await batch.commit();
      mostrarMensaje("‚úÖ Se borraron tus caminos de HOY", "#166534");
    };

    function mostrarMensaje(msg, color = "#000") {
      const div = document.getElementById("msgCaminos");
      if (!div) return;
      div.textContent = msg;
      div.style.color = color;
      setTimeout(() => div.textContent = "", 3500);
    }

    document.getElementById("caminoEstado").addEventListener("change", e => {
      const est = e.target.value;
      const prev = document.getElementById("estadoPreview");

      if (est === "transitable") { prev.textContent = "üü¢ Transitable"; prev.style.background = "#dcfce7"; }
      if (est === "complicado") { prev.textContent = "üü° Complicado"; prev.style.background = "#fef9c3"; }
      if (est === "intransitable") { prev.textContent = "üî¥ Intransitable"; prev.style.background = "#fee2e2"; }
    });

    /* ============================================================
       VECINOS (FIRESTORE) ‚úÖ
       Colecci√≥n: "vecinos"
       Campos: productorId, nombre, telefono, timestamp
    ============================================================ */

    const msgVecinos = document.getElementById("msgVecinos");
    const listaVecinos = document.getElementById("listaVecinos");

    function normalizarTel(tel) {
      // deja solo n√∫meros, √∫til para wa.me
      return (tel || "").toString().replace(/\D/g, "");
    }

    function validarTelAR(tel) {
      // No es obligatorio, pero ayuda.
      // En Argentina suele ser 549 + c√≥digo √°rea + n√∫mero (10 a 13 d√≠gitos aprox)
      return tel.length >= 10;
    }

    function mostrarMsg(el, texto, color = "#14532d", ms = 3500) {
      if (!el) return;
      el.textContent = texto;
      el.style.color = color;
      if (ms) setTimeout(() => el.textContent = "", ms);
    }

    async function agregarVecino() {
      const nombre = document.getElementById("vecinoNombre").value.trim();
      const telRaw = document.getElementById("vecinoTelefono").value.trim();
      const telefono = normalizarTel(telRaw);

      if (!productorId) return;

      if (!nombre || !telefono) {
        mostrarMsg(msgVecinos, "‚ö†Ô∏è Complet√° nombre y tel√©fono.", "#b91c1c");
        return;
      }

      if (!validarTelAR(telefono)) {
        mostrarMsg(msgVecinos, "‚ö†Ô∏è Tel√©fono inv√°lido. Us√° formato num√©rico (ej: 5493444xxxxxx).", "#b91c1c");
        return;
      }

      try {
        // Usamos el tel√©fono como ID del documento para evitar duplicados
        await setDoc(doc(db, "vecinos", `${productorId}_${telefono}`), {
          productorId,
          nombre,
          telefono,
          timestamp: serverTimestamp()
        });

        mostrarMsg(msgVecinos, "‚úÖ Vecino agregado correctamente.", "#166534");

        document.getElementById("vecinoNombre").value = "";
        document.getElementById("vecinoTelefono").value = "";
      } catch (e) {
        console.error("Error al agregar vecino:", e);
        mostrarMsg(msgVecinos, "‚ùå No se pudo agregar el vecino (revis√° permisos/reglas).", "#b91c1c", 5000);
      }
    }

    function escucharVecinos() {
      if (!productorId) return;

      const qV = query(
        collection(db, "vecinos"),
        where("productorId", "==", productorId)
      );

      onSnapshot(qV, (snap) => {
        listaVecinos.innerHTML = "";

        if (snap.empty) {
          listaVecinos.innerHTML = "<small>No hay vecinos cargados.</small>";
          return;
        }

        snap.forEach((docSnap) => {
          const v = docSnap.data();

          const item = document.createElement("div");
          item.className = "item-simple";

          item.innerHTML = `
        <div class="item-info">
          <strong>ü§ù ${v.nombre || ""}</strong><br>
          <small>${v.telefono || ""}</small>
        </div>
      `;

          // WhatsApp
          const btnWA = document.createElement("a");
          btnWA.className = "btn-secundario";
          btnWA.textContent = "WhatsApp";
          btnWA.href = `https://wa.me/${normalizarTel(v.telefono)}?text=${encodeURIComponent(
            "Hola " + (v.nombre || "") + ", te contacto desde Red Rural."
          )}`;
          btnWA.target = "_blank";

          // Editar
          const btnEdit = document.createElement("button");
          btnEdit.className = "btn-secundario";
          btnEdit.textContent = "Editar";
          btnEdit.onclick = () => editarVecino(docSnap.id, v);

          // Eliminar
          const btnDel = document.createElement("button");
          btnDel.className = "btn-secundario";
          btnDel.textContent = "Eliminar";
          btnDel.onclick = () => eliminarVecino(docSnap.id, v);

          item.appendChild(btnWA);
          item.appendChild(btnEdit);
          item.appendChild(btnDel);

          listaVecinos.appendChild(item);
        });

      }, (err) => {
        console.error("Error escuchando vecinos:", err);
        listaVecinos.innerHTML = "<small>‚ùå Sin permisos para leer vecinos (revis√° reglas).</small>";
      });
    }


    async function eliminarVecino(docId, v) {
      if (!confirm(`¬øEliminar a ${v.nombre || "este vecino"}?`)) return;
      try {
        await deleteDoc(doc(db, "vecinos", docId));
        mostrarMsg(msgVecinos, "üóëÔ∏è Vecino eliminado.", "#b91c1c");
      } catch (e) {
        console.error("Error eliminando vecino:", e);
        mostrarMsg(msgVecinos, "‚ùå No se pudo eliminar (permisos/reglas).", "#b91c1c", 5000);
      }
    }

    async function editarVecino(docId, v) {
      const nuevoNombre = prompt("Nuevo nombre:", v.nombre || "");
      if (nuevoNombre === null) return;

      const telNuevoRaw = prompt("Nuevo tel√©fono (solo n√∫meros):", v.telefono || "");
      if (telNuevoRaw === null) return;

      const telNuevo = normalizarTel(telNuevoRaw);

      if (!nuevoNombre.trim() || !telNuevo.trim()) {
        mostrarMsg(msgVecinos, "‚ö†Ô∏è Nombre y tel√©fono son obligatorios.", "#b91c1c");
        return;
      }
      if (!validarTelAR(telNuevo)) {
        mostrarMsg(msgVecinos, "‚ö†Ô∏è Tel√©fono inv√°lido.", "#b91c1c");
        return;
      }

      try {
        // ‚úÖ Caso 1: No cambi√≥ el tel√©fono ‚Üí update normal
        if (telNuevo === (v.telefono || "")) {
          await updateDoc(doc(db, "vecinos", docId), {
            nombre: nuevoNombre.trim(),
            telefono: telNuevo,
            timestamp: serverTimestamp()
          });
          mostrarMsg(msgVecinos, "‚úÖ Vecino actualizado.", "#166534");
          return;
        }

        // ‚úÖ Caso 2 (tu caso): el ID del doc usa tel√©fono ‚Üí hay que ‚Äúmover‚Äù el doc
        // vos cre√°s con ID `${productorId}_${telefono}` :contentReference[oaicite:5]{index=5}
        const nuevoId = `${productorId}_${telNuevo}`;

        const batch = writeBatch(db);
        batch.set(doc(db, "vecinos", nuevoId), {
          productorId,
          nombre: nuevoNombre.trim(),
          telefono: telNuevo,
          timestamp: serverTimestamp()
        });
        batch.delete(doc(db, "vecinos", docId));
        await batch.commit();

        mostrarMsg(msgVecinos, "‚úÖ Vecino actualizado (tel√©fono cambiado).", "#166534");
      } catch (e) {
        console.error("Error editando vecino:", e);
        mostrarMsg(msgVecinos, "‚ùå No se pudo editar (permisos/reglas).", "#b91c1c", 5000);
      }
    }


    /* ============================================================
   ‚úÖ UI: VECINOS SELECCIONABLES PARA ALERTAS
    ============================================================ */

    const listaVecinosAlertas = document.getElementById("listaVecinosAlertas");
    const btnSelTodosVecinos = document.getElementById("btnSelTodosVecinos");
    const btnSelNingunoVecinos = document.getElementById("btnSelNingunoVecinos");

    let vecinosCacheAlertas = []; // [{id, nombre, tel}]

    function renderVecinosParaAlertas() {
      if (!listaVecinosAlertas) return;

      if (!vecinosCacheAlertas.length) {
        listaVecinosAlertas.innerHTML = "<small>No hay vecinos cargados.</small>";
        return;
      }

      listaVecinosAlertas.innerHTML = "";

      vecinosCacheAlertas.forEach((v, i) => {
        const item = document.createElement("div");
        item.className = "item-simple";
        item.style.alignItems = "flex-start";

        item.innerHTML = `
      <label style="display:flex; gap:10px; width:100%; cursor:pointer;">
        <input class="chk-vecino-alerta" type="checkbox" data-tel="${v.tel}" style="margin-top:4px;">
        <div class="item-info">
          <strong>ü§ù ${v.nombre}</strong><br>
          <small>${v.tel}</small>
        </div>
      </label>
    `;

        listaVecinosAlertas.appendChild(item);
      });
    }

    function setTodosVecinosAlertas(valor) {
      document.querySelectorAll(".chk-vecino-alerta").forEach(chk => chk.checked = valor);
    }

    btnSelTodosVecinos?.addEventListener("click", () => setTodosVecinosAlertas(true));
    btnSelNingunoVecinos?.addEventListener("click", () => setTodosVecinosAlertas(false));

    function obtenerTelefonosSeleccionadosDesdeUI() {
      const tels = [];
      document.querySelectorAll(".chk-vecino-alerta").forEach(chk => {
        if (chk.checked) {
          const tel = chk.dataset.tel;
          if (tel) tels.push(tel);
        }
      });
      return tels;
    }

    // ‚úÖ escucha vecinos y llena el selector visual de alertas
    function escucharVecinosParaAlertas() {
      if (!productorId) return;

      const qV = query(collection(db, "vecinos"), where("productorId", "==", productorId));

      onSnapshot(qV, (snap) => {
        vecinosCacheAlertas = [];

        snap.forEach((docSnap) => {
          const v = docSnap.data();
          const tel = normalizarTel(v.telefono);
          if (tel) vecinosCacheAlertas.push({
            id: docSnap.id,
            nombre: v.nombre || "Vecino",
            tel
          });
        });

        renderVecinosParaAlertas();
        // por defecto: no selecciona ninguno (si quer√©s que seleccione todos, cambialo a true)
        setTodosVecinosAlertas(false);
      }, (err) => {
        console.error("Error vecinos para alertas:", err);
        if (listaVecinosAlertas) listaVecinosAlertas.innerHTML = "<small>‚ùå Sin permisos para leer vecinos.</small>";
      });
    }


    /* ============================================================
       ALERTAS (FIRESTORE + ENV√çO POR WHATSAPP) ‚úÖ
       Guarda en colecci√≥n "alertas" y prepara env√≠o a vecinos
    ============================================================ */

    const msgAlertas = document.getElementById("msgAlertas");
    const listaAlertas = document.getElementById("listaAlertas");

    async function guardarAlertaFirestore(tipo, descripcion) {
      // guarda la alerta para historial
      return await addDoc(collection(db, "alertas"), {
        productorId,
        tipo,
        descripcion,
        fecha: Date.now(),
        timestamp: serverTimestamp()
      });
    }

    function escucharAlertas() {
      if (!productorId) return;

      const qA = query(
        collection(db, "alertas"),
        where("productorId", "==", productorId)
      );

      onSnapshot(qA, (snap) => {
        listaAlertas.innerHTML = "";
        if (snap.empty) {
          listaAlertas.innerHTML = "<small>No hay alertas enviadas.</small>";
          return;
        }

        snap.forEach((docSnap) => {
          const a = docSnap.data();
          const fechaTxt = a.fecha ? new Date(a.fecha).toLocaleString("es-AR") : "";

          const item = document.createElement("div");
          item.className = "item-simple";
          item.innerHTML = `
        <div class="item-info">
          <strong>üö® ${a.tipo || "Alerta"}</strong><br>
          <small>${a.descripcion || ""}</small><br>
          <small>${fechaTxt}</small>
        </div>
      `;

          listaAlertas.appendChild(item);
        });
      });
    }

    async function obtenerTelefonosVecinos() {
      const q = query(collection(db, "vecinos"), where("productorId", "==", productorId));
      const snap = await getDocs(q);
      const tels = [];
      snap.forEach((d) => {
        const tel = normalizarTel(d.data().telefono);
        if (tel) tels.push(tel);
      });
      return tels;
    }

    function abrirWhatsAppLista(telefonos, mensaje) {
      // Evita abrir 30 ventanas de golpe: las abre escalonadas.
      // Aun as√≠, el navegador puede bloquear si no permit√≠s popups.
      const msg = encodeURIComponent(mensaje);
      telefonos.forEach((tel, i) => {
        setTimeout(() => {
          window.open(`https://wa.me/${tel}?text=${msg}`, "_blank");
        }, i * 350);
      });
    }

    document.getElementById("btnAgregarVecino").addEventListener("click", agregarVecino);

    document.getElementById("btnEnviarAlerta").addEventListener("click", async () => {
      const tipo = document.getElementById("alertaTipo").value;
      const descripcion = document.getElementById("alertaDescripcion").value.trim();

      if (!descripcion) {
        mostrarMsg(msgAlertas, "‚ö†Ô∏è Complet√° la descripci√≥n de la alerta.", "#b91c1c");
        return;
      }

      if (!productorId) return;

      try {
        // 1) Guardar alerta en Firestore
        await guardarAlertaFirestore(tipo, descripcion);

        // 2) Traer vecinos y abrir WhatsApp
        const telsVecinos = obtenerTelefonosSeleccionadosDesdeUI();


        if (!telsVecinos.length) {
          mostrarMsg(msgAlertas, "‚ö†Ô∏è Alerta guardada, pero no hay vecinos cargados para enviar.", "#b45309", 6000);
          document.getElementById("alertaDescripcion").value = "";
          return;
        }

        const mensaje = `üö® ALERTA RED RURAL\nTipo: ${tipo}\nDetalle: ${descripcion}\n\nüìç Esta alerta fue emitida desde el Panel del Productor para advertir una situaci√≥n en la zona.`;
        abrirWhatsAppLista(telsVecinos, mensaje);

        mostrarMsg(msgAlertas, `‚úÖ Alerta guardada y lista para enviar a ${telsVecinos.length} vecino(s).`, "#166534", 6000);

        document.getElementById("alertaDescripcion").value = "";
      } catch (e) {
        console.error("Error enviando alerta:", e);
        mostrarMsg(msgAlertas, "‚ùå Error al enviar alerta (revis√° permisos/reglas).", "#b91c1c", 6000);
      }
    });

    function initCalculadora() {
      const ha = document.getElementById("calcHa");
      const kgHa = document.getElementById("calcKgHa");
      const agroUnidad = document.getElementById("agroUnidad");
      const agroTitulo = document.getElementById("agroTitulo");
      const btnTotal = document.getElementById("btnCalcTotal");

      const btnTotalClear = document.getElementById("btnCalcTotalClear");
      const resTotal = document.getElementById("resCalcTotal");

      const nkg = document.getElementById("calcNkg");
      const btnUrea = document.getElementById("btnCalcUrea");
      const btnUreaClear = document.getElementById("btnCalcUreaClear");
      const resUrea = document.getElementById("resCalcUrea");
      // üêÑ Ganader√≠a: MS
      const ganPeso = document.getElementById("ganPeso");
      const ganPorcMS = document.getElementById("ganPorcMS");
      const ganCabezas = document.getElementById("ganCabezas");
      const btnMS = document.getElementById("btnCalcMS");
      const btnMSClear = document.getElementById("btnCalcMSClear");
      const resMS = document.getElementById("resCalcMS");


      // ‚úÖ Guard: si la secci√≥n no est√° (por alg√∫n error), no rompe
      if (!btnTotal || !btnUrea || !btnMS) return;

      const fmt = (n) => new Intl.NumberFormat("es-AR", { maximumFractionDigits: 2 }).format(n);

      function actualizarUIAgroUnidad() {
        const unidad = agroUnidad?.value || "kg";
        const uHaTxt = unidad === "l" ? "L/ha" : "kg/ha";
        const uTotTxt = unidad === "l" ? "Litros" : "kg";

        if (agroTitulo) agroTitulo.textContent = `üß™ Fertilizante total (${uHaTxt} ‚Üí ${uTotTxt})`;

        // cambia el placeholder del input de dosis
        if (kgHa) kgHa.placeholder = `Dosis ${uHaTxt} (ej: ${unidad === "l" ? "8" : "120"})`;
      }
      if (agroUnidad) {
        agroUnidad.addEventListener("change", actualizarUIAgroUnidad);
        actualizarUIAgroUnidad(); // estado inicial apenas carga
      }


      btnTotal.addEventListener("click", () => {
        const haVal = Number(ha.value);
        const kgHaVal = Number(kgHa.value);

        if (!haVal || !kgHaVal || haVal <= 0 || kgHaVal <= 0) {
          resTotal.style.color = "#b91c1c";
          resTotal.textContent = "‚ö†Ô∏è Complet√° hect√°reas y kg/ha con valores mayores a 0.";
          return;
        }

        const total = haVal * kgHaVal;

        const unidad = agroUnidad?.value || "kg"; // por si no existiera, cae en kg
        const uTxt = unidad === "l" ? "Litros" : "kg";
        const uHaTxt = unidad === "l" ? "L/ha" : "kg/ha";

        resTotal.style.color = "#166534";
        resTotal.textContent = `‚úÖ Total: ${fmt(total)} ${uTxt} (para ${fmt(haVal)} ha a ${fmt(kgHaVal)} ${uHaTxt}).`;

      });

      btnTotalClear.addEventListener("click", () => {
        ha.value = "";
        kgHa.value = "";
        if (agroUnidad) agroUnidad.value = "kg";
        resTotal.textContent = "";

      });

      btnUrea.addEventListener("click", () => {
        const nVal = Number(nkg.value);
        if (!nVal || nVal <= 0) {
          resUrea.style.color = "#b91c1c";
          resUrea.textContent = "‚ö†Ô∏è Ingres√° kg de N total (mayor a 0).";
          return;
        }

        const ureaKg = nVal / 0.46;
        resUrea.style.color = "#166534";
        resUrea.textContent = `‚úÖ Urea necesaria: ${fmt(ureaKg)} kg (para aportar ${fmt(nVal)} kg de N).`;
      });

      btnUreaClear.addEventListener("click", () => {
        nkg.value = "";
        resUrea.textContent = "";
      });

      // ‚úÖ Consumo de Materia Seca
      btnMS.addEventListener("click", () => {
        const pv = Number(ganPeso.value);
        const porc = Number(ganPorcMS.value);
        const cab = Number(ganCabezas.value);

        if (!pv || !porc || !cab || pv <= 0 || porc <= 0 || cab <= 0) {
          resMS.style.color = "#b91c1c";
          resMS.textContent = "‚ö†Ô∏è Complet√° peso, %MS y cabezas con valores mayores a 0.";
          return;
        }

        const msPorCabDia = pv * (porc / 100);
        const totalDia = msPorCabDia * cab;
        const totalMes = totalDia * 30;

        resMS.style.color = "#166534";
        resMS.textContent =
          `‚úÖ MS por animal/d√≠a: ${fmt(msPorCabDia)} kg ‚Ä¢ Total/d√≠a: ${fmt(totalDia)} kg ‚Ä¢ Total/mes: ${fmt(totalMes)} kg`;
      });

      btnMSClear.addEventListener("click", () => {
        ganPeso.value = "";
        ganPorcMS.value = "";
        ganCabezas.value = "";
        resMS.textContent = "";
      });

    }





  </script>
</body>

</html>