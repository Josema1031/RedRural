<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <title>Panel del Productor â€” RuralControl</title>

  <style>
    /* âœ… Responsive base */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f3f4f6;
    }

    header {
      background: #14532d;
      color: white;
      padding: 16px;
      text-align: center;
    }

    .container {
      padding: 20px;
      max-width: 1000px;
      margin: auto;
      width: 100%;
    }

    h2 {
      margin-top: 25px;
      color: #14532d;
      font-weight: 800;
      position: relative;
      padding-bottom: 6px;
      display: inline-block;
    }

    h2::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      width: 35%;
      height: 3px;
      background: #14532d;
      border-radius: 3px;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 25px rgba(0, 0, 0, .10);
    }


    .fila {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    input,
    select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      flex: 1;
      min-width: 220px;
    }

    .btn-primario {
      background: #14532d;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-pro {
      background-color: #14532d;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-secundario {
      background: #e5e7eb;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-mini {
      margin-top: 10px;
      background: #7f1d1d;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .lista-simple {
      margin-top: 15px;
    }

    /* Tarjetas elevadas estilo app */
    .item-simple {
      background: white;
      padding: 14px;
      border-radius: 14px;
      margin-bottom: 14px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      transition: transform .12s ease, box-shadow .12s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .item-simple:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .item-simple .item-info {
      min-width: 0;
    }

    /* ========================================================= */
    /* CHIPS MODERNOS PARA FILTROS */
    /* ========================================================= */
    .filtro-chip {
      background: #e5e7eb;
      padding: 6px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      border: 1px solid #d1d5db;
      transition: all 0.2s ease;
      user-select: none;
    }

    .filtro-chip:hover {
      background: #d1d5db;
    }

    .filtro-chip.activo {
      background: #14532d;
      color: white;
      border-color: #14532d;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .chip-categoria {
      background: #d1fae5;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
    }

    .chip-prioridad-alta {
      background: #fecaca;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
    }

    .chip-prioridad-media {
      background: #fef08a;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
    }

    .chip-prioridad-baja {
      background: #bbf7d0;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
    }

    .status-msg {
      margin-top: 10px;
      font-size: 14px;
    }

    /* ==================================== */
    /* NAV AVANZADO ESTILO APP */
    /* ==================================== */

    .nav-panel {
      display: flex;
      overflow-x: auto;
      padding: 8px;
      gap: 10px;
      background: #eaf2ec;
      border-bottom: 1px solid #d1d5db;
    }

    .nav-btn {
      flex: 1;
      min-width: 120px;
      background: #14532d;
      color: white;
      border: none;
      padding: 12px 0;
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      position: relative;
      transition: all 0.25s ease;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
    }

    .nav-btn .icono {
      font-size: 20px;
      transition: transform 0.2s ease;
    }

    .nav-btn .texto {
      font-size: 14px;
      font-weight: bold;
    }

    .nav-btn .indicador {
      position: absolute;
      bottom: -5px;
      width: 0px;
      height: 4px;
      background: #1e7a42;
      border-radius: 4px;
      transition: width 0.25s ease;
    }

    .nav-btn.activo {
      background: #1e7a42;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .nav-btn.activo .icono {
      transform: scale(1.25);
    }

    .nav-btn.activo .indicador {
      width: 40%;
    }

    .hidden {
      display: none;
    }

    section {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .25s ease, transform .25s ease;
    }

    section.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .tooltip-camino {
      background: white;
      border: 1px solid #d1d5db;
      padding: 4px 8px;
      border-radius: 8px;
      color: #111827;
      font-size: 12px;
      font-weight: bold;
    }

    #mapCaminos,
    #mapMarcaciones {
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.12);
      border: 1px solid #d1d5db;
    }

    .leaflet-popup-content {
      font-size: 14px;
      line-height: 18px;
    }

    .leaflet-popup-content-wrapper {
      border-radius: 12px;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
    }

    .leaflet-popup-tip {
      background: white;
      border: 1px solid #d1d5db;
    }

    /* NAV: botones un poco mÃ¡s chicos en pantallas medianas */
    @media (max-width: 900px) {
      header {
        padding: 12px;
      }

      .container {
        padding: 14px;
      }

      .nav-btn {
        min-width: 105px;
        padding: 10px 0;
      }

      .nav-btn .texto {
        font-size: 13px;
      }
    }

    /* MÃ³vil */
    @media (max-width: 600px) {
      header h1 {
        font-size: 18px;
      }

      .container {
        padding: 12px;
      }

      .fila {
        flex-direction: column;
        gap: 8px;
      }

      input,
      select {
        width: 100%;
        min-width: 0;
      }

      .btn-primario,
      .btn-secundario,
      .btn-mini {
        width: 100%;
      }

      .item-simple {
        flex-direction: column;
        align-items: flex-start;
      }

      .item-simple a.btn-primario,
      .item-simple button.btn-secundario {
        width: 100%;
        text-align: center;
      }

      #mapCaminos,
      #mapMarcaciones {
        height: 240px !important;
      }
    }

    @media (max-width: 380px) {
      .nav-btn {
        min-width: 95px;
      }

      .nav-btn .icono {
        font-size: 18px;
      }

      .nav-btn .texto {
        font-size: 12px;
      }
    }

    /* ============================
   HOY â€“ Botones en fila (mobile)
   ============================ */
    @media (max-width: 600px) {

      /* Forzamos fila horizontal SOLO en este bloque */
      .filaHoy {
        display: flex !important;
        flex-direction: row !important;
        /* ğŸ”¥ clave */
        flex-wrap: wrap !important;
        gap: 10px;
        justify-content: flex-start;
        align-items: center;
      }

      .filaHoy .btn-primario,
      .filaHoy .btn-secundario {
        width: auto !important;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 12px;
        font-size: 13px;
        border-radius: 10px;
        white-space: nowrap;
        margin: 0 !important;
        /* por si hay mÃ¡rgenes viejos */
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>Panel del Productor</h1>
  </header>
  <!-- âœ… BANNER DE PLAN (monetizaciÃ³n) -->
  <div id="bannerPlan" style="background:#fff; border-bottom:1px solid #e5e7eb;">
    <div
      style="max-width:1000px;margin:auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
      <div>
        <strong id="planTitulo">Plan: â€”</strong>
        <div id="planSub" style="font-size:13px;color:#6b7280;margin-top:2px;">â€”</div>
      </div>
      <button id="btnProWhats" class="btn-pro">Plan PRO</button>

    </div>
  </div>
  <div id="adminProBox" style="display:none; width:100%; margin-top:10px;">
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <input id="adminUidInput" placeholder="UID del productor (del WhatsApp)"
        style="flex:1; min-width:240px; padding:10px; border-radius:8px; border:1px solid #ccc;">
      <button id="adminActivarPro" class="btn-primario" type="button">âœ… Plan PRO</button>
      <button id="adminPonerFree" class="btn-secundario" type="button">â†© Volver a FREE</button>
    </div>
    <small style="display:block; margin-top:6px; color:#6b7280;">
      (Visible solo para admin)
    </small>
  </div>




  <!-- NAV -->
  <nav class="nav-panel">

    <button data-target="sec-hoy" class="nav-btn activo">
      <span class="icono">ğŸ“Œ</span>
      <span class="texto">HOY</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-empleados" class="nav-btn">
      <span class="icono">ğŸ‘·</span>
      <span class="texto">Empleados</span>
      <div class="indicador"></div>
    </button>


    <button data-target="sec-clima" class="nav-btn">
      <span class="icono">ğŸŒ¦ï¸</span>
      <span class="texto">Clima</span>
      <div class="indicador"></div>
    </button>


    <button data-target="sec-camiones" class="nav-btn">
      <span class="icono">ğŸšš</span>
      <span class="texto">Camiones</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-caminos" class="nav-btn">
      <span class="icono">ğŸ›£ï¸</span>
      <span class="texto">Caminos</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-vecinos" class="nav-btn">
      <span class="icono">ğŸ¤</span>
      <span class="texto">Vecinos</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-alertas" class="nav-btn">
      <span class="icono">ğŸš¨</span>
      <span class="texto">Alertas</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-tareas" class="nav-btn">
      <span class="icono">ğŸ“</span>
      <span class="texto">Tareas</span>
      <div class="indicador"></div>
    </button>

    <button data-target="sec-calculadora" class="nav-btn">
      <span class="icono">ğŸ§®</span>
      <span class="texto">Calculadora</span>
      <div class="indicador"></div>
    </button>


  </nav>

  <div class="container">

    <!-- ============================= -->
    <!-- SECCIÃ“N: EMPLEADOS -->
    <!-- ============================= -->
    <section id="sec-empleados" class="visible">
      <h2>GestiÃ³n de empleados</h2>
      <small>RegistrÃ¡ los empleados que trabajan en tu establecimiento.</small>

      <div class="fila" style="margin-top:15px;">
        <input type="text" id="empNombre" placeholder="Nombre del empleado">
        <input type="text" id="empDni" placeholder="DNI">
        <input type="text" id="empTelefono" placeholder="TelÃ©fono (WhatsApp)">
        <input type="text" id="empClave" placeholder="Clave de acceso">
        <button class="btn-primario" id="btnAgregarEmpleado">â• Agregar</button>
      </div>

      <p class="status-msg" id="msgEmpleado"></p>
      <div id="listaEmpleados" class="lista-simple"></div>
    </section>

    <!-- ============================= -->
    <!-- SECCIÃ“N: HOY (DASHBOARD) -->
    <!-- ============================= -->
    <section id="sec-hoy" class="hidden">
      <h2>ğŸ“Œ HOY</h2>
      <small>Resumen rÃ¡pido y tareas crÃ­ticas del dÃ­a.</small>

      <div class="card" style="margin-top:14px;">
        <div class="fila" style="align-items:stretch;">
          <div class="card" style="flex:1; min-width:220px;">
            <strong>ğŸ‘· Empleados</strong>
            <div id="hoyEmpleados" style="font-size:22px;font-weight:900;margin-top:6px;">â€”</div>
            <div class="muted" style="margin-top:6px;">Registrados</div>
          </div>

          <div class="card" style="flex:1; min-width:220px;">
            <strong>ğŸ“ Pendientes</strong>
            <div id="hoyPendientes" style="font-size:22px;font-weight:900;margin-top:6px;">â€”</div>
            <div class="muted" style="margin-top:6px;">Tareas sin completar</div>
          </div>

          <div class="card" style="flex:1; min-width:220px;">
            <strong>ğŸš¨ Alertas (24h)</strong>
            <div id="hoyAlertas24" style="font-size:22px;font-weight:900;margin-top:6px;">â€”</div>
            <div class="muted" style="margin-top:6px;">Generadas en las Ãºltimas 24h</div>
          </div>

          <div class="card" style="flex:1; min-width:220px;">
            <strong>ğŸ›£ï¸ Caminos mal</strong>
            <div id="hoyCaminosMalos" style="font-size:22px;font-weight:900;margin-top:6px;">â€”</div>
            <div class="muted" style="margin-top:6px;">Complicados/Intransitables hoy</div>
          </div>

          <div class="card" style="flex:1; min-width:220px;">
            <strong>ğŸšš Camiones</strong>
            <div id="hoyCamionesOff" style="font-size:22px;font-weight:900;margin-top:6px;">â€”</div>
            <div class="muted" style="margin-top:6px;">Disponible ahora</div>
          </div>
        </div>

        <div class="filaHoy" style="margin-top:12px;">
          <button class="btn-primario" id="btnHoyRefrescar">ğŸ”„ Actualizar HOY</button>
          <button class="btn-secundario" id="btnHoyIrTareas" type="button">ğŸ“ Ir a Tareas</button>
          <button class="btn-secundario" id="btnHoyIrCaminos" type="button">ğŸ›£ï¸ Ir a Caminos</button>
          <button class="btn-secundario" id="btnHoyIrAlertas" type="button">ğŸš¨ Ir a Alertas</button>
          <button class="btn-secundario" id="btnHoyIrCamiones" type="button">ğŸšš Ir a Camiones</button>
        </div>

        <div class="card" style="margin-top:14px;">
          <strong>âš¡ Pendientes crÃ­ticos</strong>
          <div id="hoyListaPendientes" class="lista-simple" style="margin-top:10px;">
            <small class="muted">Cargando...</small>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <strong>ğŸ“£ Ãšltimas alertas</strong>
          <div id="hoyListaAlertas" class="lista-simple" style="margin-top:10px;">
            <small class="muted">Cargando...</small>
          </div>
        </div>

        <p id="hoyMsg" class="status-msg"></p>
      </div>
    </section>

    <!-- ============================= -->
    <!-- SECCIÃ“N: CAMIONES (TRACKING) -->
    <!-- ============================= -->
    <section id="sec-camiones" class="hidden">
      <h2>Monitoreo de camiones</h2>
      <small>UbicaciÃ³n en tiempo real del chofer (celular) con GPS.</small>

      <div id="mapCamiones" style="width:100%; height:330px; margin-top:15px; background:#ddd; border-radius:10px;">
      </div>

      <p class="status-msg" id="msgCamiones"></p>
      <div id="listaCamiones" class="lista-simple"></div>
      <hr style="margin:14px 0; border:none; border-top:1px solid #e5e7eb;">

      <h3 style="margin:10px 0 6px; color:#14532d;">ğŸ“’ Registro de recorridos</h3>
      <small class="muted">Guardados cuando el chofer toca â€œDetenerâ€.</small>

      <p class="status-msg" id="msgViajes"></p>
      <div id="listaViajes" class="lista-simple"></div>

      <div class="fila" style="margin-top:10px;">
        <button class="btn-secundario" id="btnLimpiarRuta">ğŸ§¹ Limpiar ruta del mapa</button>

      </div>


    </section>


    <!-- ============================= -->
    <!-- SECCIÃ“N: VECINOS -->
    <!-- ============================= -->
    <section id="sec-vecinos" class="hidden">
      <h2>Vecinos de la zona</h2>
      <small>AgregÃ¡ contactos de confianza cerca de tu campo.</small>

      <div class="fila">
        <input type="text" id="vecinoNombre" placeholder="Nombre del vecino">
        <input type="text" id="vecinoTelefono" placeholder="TelÃ©fono">
        <button class="btn-primario" id="btnAgregarVecino">â• Agregar</button>
      </div>

      <p class="status-msg" id="msgVecinos"></p>
      <div id="listaVecinos" class="lista-simple"></div>
    </section>

    <!-- ============================= -->
    <!-- SECCIÃ“N: ALERTAS -->
    <!-- ============================= -->
    <section id="sec-alertas" class="hidden">
      <h2>Alertas rurales</h2>
      <small>EnviÃ¡ alertas rÃ¡pidas a tus empleados.</small>

      <div class="fila">
        <select id="alertaTipo">
          <option value="Vehiculo Sospechoso">ğŸš¨Vehiculo Sospechoso</option>
          <option value="Animal perdido">ğŸ„ Animales perdido</option>
          <option value="Incendio">ğŸ”¥ Incendio</option>
          <option value="AverÃ­a">ğŸ›  AverÃ­a</option>
          <option value="Otro">ğŸ“¦ Otro</option>
        </select>

        <input type="text" id="alertaDescripcion" placeholder="DescripciÃ³n">
        <button class="btn-primario" id="btnEnviarAlerta">ğŸ“¢ Enviar</button>
      </div>

      <p class="status-msg" id="msgAlertas"></p>
      <div id="listaAlertas" class="lista-simple"></div>

      <!-- âœ… SelecciÃ³n visual de vecinos para enviar alerta -->
      <div style="margin-top:14px;">
        <h3 style="margin:10px 0 6px; color:#14532d;">ğŸ“² Enviar a vecinos</h3>

        <div class="fila" style="margin-top:6px;">
          <button class="btn-secundario" id="btnSelTodosVecinos" type="button">Seleccionar todos</button>
          <button class="btn-secundario" id="btnSelNingunoVecinos" type="button">Ninguno</button>
        </div>

        <div id="listaVecinosAlertas" class="lista-simple"></div>

        <small style="display:block;margin-top:8px;color:#6b7280;">

        </small>
      </div>

    </section>

    <!-- ============================= -->
    <!-- SECCIÃ“N: CAMINOS -->
    <!-- ============================= -->
    <section id="sec-caminos" style="position:relative;" class="hidden">
      <h2>Estado de caminos</h2>
      <small>PodÃ©s marcar puntos o tramos completos en el mapa.</small>

      <div class="fila" style="margin-top:10px;">
        <select id="caminoEstado">
          <option value="transitable">ğŸŸ¢ Transitable</option>
          <option value="complicado">ğŸŸ¡ Complicado</option>
          <option value="intransitable">ğŸ”´ Intransitable</option>
        </select>

        <span id="estadoPreview" style="
          padding:6px 10px;
          border-radius:10px;
          font-weight:bold;
          background:#e5e7eb;
          color:#111;
        "></span>

        <button class="btn-primario" id="btnModoPunto">Marcar punto</button>
        <button class="btn-secundario" id="btnModoTramo">Marcar tramo</button>
        <button class="btn-primario" id="btnGuardarTramo" style="display:none;">Guardar tramo</button>
        <button class="btn-secundario" id="btnCentrarUbicacion">ğŸ“ Centrar en mi ubicaciÃ³n</button>

      </div>

      <div class="fila" style="margin-top:10px; gap:8px;">
        <div class="filtro-chip" id="filtroTodos">Todos</div>
        <div class="filtro-chip" id="filtroTransitable">ğŸŸ¢ Transitable</div>
        <div class="filtro-chip" id="filtroComplicado">ğŸŸ¡ Complicado</div>
        <div class="filtro-chip" id="filtroIntransitable">ğŸ”´ Intransitable</div>

        <button class="btn-mini" id="btnBorrarMisCaminosHoy">ğŸ—‘ Mis caminos de hoy</button>
      </div>

      <div id="mapCaminos" style="width:100%; height:330px; margin-top:15px; background:#ddd; border-radius:10px;">
      </div>

      <div id="leyendaCaminos" style="
        position:absolute;
        bottom:25px; right:10px;
        background:white;
        padding:8px 12px;
        border-radius:10px;
        border:1px solid #d1d5db;
        font-size:13px;
        box-shadow:0px 2px 6px rgba(0,0,0,0.15);
        line-height:18px;
      ">
        <div>ğŸŸ¢ Transitable</div>
        <div>ğŸŸ¡ Complicado</div>
        <div>ğŸ”´ Intransitable</div>
      </div>

      <p id="msgCaminos" class="status-msg"></p>
    </section>

    <!-- ============================= -->
    <!-- SECCIÃ“N: TAREAS -->
    <!-- ============================= -->
    <section id="sec-tareas" class="hidden">
      <h2>Registro de tareas diarias</h2>
      <small>CargÃ¡ las tareas del dÃ­a y marcÃ¡ cuÃ¡les se completaron.</small>

      <div class="fila">
        <input type="text" id="nuevaTareaTexto" placeholder="Ej: Revisar bebederos del potrero 3" />

        <select id="tareaCategoria">
          <option value="GanaderÃ­a">ğŸ„ GanaderÃ­a</option>
          <option value="Cultivos">ğŸŒ½ Cultivos</option>
          <option value="Maquinaria">ğŸšœ Maquinaria</option>
          <option value="Mantenimiento">ğŸ›  Mantenimiento</option>
          <option value="Seguridad">ğŸš¨ Seguridad</option>
          <option value="Limpieza">ğŸ§¹ Limpieza</option>
          <option value="Otros">ğŸ“¦ Otros</option>
        </select>

        <select id="tareaPrioridad">
          <option value="Alta">ğŸ”´ Alta</option>
          <option value="Media">ğŸŸ¡ Media</option>
          <option value="Baja">ğŸŸ¢ Baja</option>
        </select>

        <select id="tareaEmpleado">
          <option value="">(sin asignar)</option>
        </select>

        <button class="btn-primario" id="btnAgregarTarea">â• Agregar</button>
      </div>

      <p class="status-msg" id="msgTareas"></p>
      <div id="listaTareas" class="lista-simple"></div>


    </section>


    <!-- ============================= -->
    <!-- SECCIÃ“N: CLIMA -->
    <!-- ============================= -->

    <section id="sec-clima" class="hidden">
      <h2>Clima</h2>
      <small>PronÃ³stico y alertas para el campo.</small>

      <div class="card" style="margin-top:14px;">
        <div class="fila">
          <input id="climaLugar" type="text" placeholder="Buscar lugar (ej: Gualeguay, Entre RÃ­os)">
          <button class="btn-secundario" id="btnClimaBuscar" type="button">Buscar</button>
          <button class="btn-secundario" id="btnClimaGPS" type="button">ğŸ“ Mi ubicaciÃ³n</button>
        </div>

        <p class="status-msg" id="msgClima"></p>

        <div id="climaActual" class="card" style="margin-top:12px;">
          <strong>Ahora</strong>
          <div id="climaActualBody" style="margin-top:8px; color:#374151;"></div>
        </div>

        <div id="climaAlertas" class="card" style="margin-top:12px;">
          <strong>Alertas</strong>
          <div id="climaAlertasBody" style="margin-top:8px; color:#374151;"></div>
        </div>

        <div id="clima7dias" class="card" style="margin-top:12px;">
          <strong>7 dÃ­as</strong>
          <div id="clima7diasBody" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>


    <!-- ============================= -->
    <!-- SECCIÃ“N: CALCULADORA -->
    <!-- ============================= -->
    <section id="sec-calculadora" class="hidden">
      <h2>Calculadora agropecuaria</h2>
      <small>Herramientas rÃ¡pidas para campo (fertilizaciÃ³n y mÃ¡s).</small>

      <!-- 1) kg/ha â†’ total -->
      <div class="card" style="margin-top:14px;">
        <h3 id="agroTitulo" style="margin:0 0 8px; color:#14532d;">ğŸ§ª Fertilizante total (por ha â†’ total)</h3>


        <div class="fila">
          <input id="calcHa" type="number" step="0.01" placeholder="HectÃ¡reas (ej: 25.5)">
          <input id="calcKgHa" type="number" step="0.1" placeholder="Dosis por ha (ej: 120)">

          <select id="agroUnidad">
            <option value="kg">Kg/ha</option>
            <option value="l">L/ha</option>
          </select>

          <button class="btn-primario" id="btnCalcTotal">Calcular</button>
          <button class="btn-secundario" id="btnCalcTotalClear" type="button">Limpiar</button>
          <p class="status-msg" id="resCalcTotal"></p>
        </div>


        <!-- 2) N requerido â†’ Urea -->
        <div class="card" style="margin-top:14px;">
          <h3 style="margin:0 0 8px; color:#14532d;">ğŸŒ¿ NitrÃ³geno â†’ Urea (46% N)</h3>
          <div class="fila">
            <input id="calcNkg" type="number" step="0.1" placeholder="N requerido (kg de N total)">
            <button class="btn-primario" id="btnCalcUrea">Calcular</button>
            <button class="btn-secundario" id="btnCalcUreaClear" type="button">Limpiar</button>
          </div>
          <p class="status-msg" id="resCalcUrea"></p>

          <small style="display:block;color:#6b7280;margin-top:6px;">
            FÃ³rmula: Urea (kg) = N (kg) / 0.46
          </small>
        </div>

        <!-- 3) GANADERÃA: Consumo Materia Seca -->
        <div class="card" style="margin-top:14px;">
          <h3 style="margin:0 0 8px; color:#14532d;">ğŸ„ GanaderÃ­a: Consumo de Materia Seca</h3>
          <div class="fila">
            <input id="ganPeso" type="number" step="0.1" placeholder="Peso vivo (kg) ej: 380">
            <input id="ganPorcMS" type="number" step="0.1" placeholder="% MS del PV ej: 2.5">
            <input id="ganCabezas" type="number" step="1" placeholder="Cantidad de animales ej: 120">
          </div>

          <div class="fila">
            <button class="btn-primario" id="btnCalcMS">Calcular</button>
            <button class="btn-secundario" id="btnCalcMSClear" type="button">Limpiar</button>
          </div>

          <p class="status-msg" id="resCalcMS"></p>

          <small style="display:block;color:#6b7280;margin-top:6px;">
            FÃ³rmulas: MS/dÃ­a/cab = PV * (%MS/100) â€¢ Total/dÃ­a = MS/cab * cabezas â€¢ Mes = Total/dÃ­a * 30
          </small>
        </div>

    </section>


  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { auth, db, firebaseConfig } from "../firebase-init.js?v=2";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { onAuthStateChanged, getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, query, where, onSnapshot, orderBy,
      doc, setDoc, updateDoc, deleteDoc, writeBatch, serverTimestamp,
      getDocs, getDoc, addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const secondaryApp = initializeApp(firebaseConfig, "secondary");
    const secondaryAuth = getAuth(secondaryApp);

    let productorId = null;

    // =========================
    // 1) GATE POR AUTH
    // =========================
    let planActual = "free"; // default

    // =========================
    // âœ… ADMIN: tu UID
    // =========================
    // ğŸ”´ ReemplazÃ¡ por TU UID real (Firebase Auth UID)
    const ADMIN_UIDS = new Set([
      "TU_UID_ADMIN_AQUI"
    ]);

    function soyAdmin() {
      return auth.currentUser && ADMIN_UIDS.has(auth.currentUser.uid);
    }


    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Debes iniciar sesiÃ³n como Productor.");
        window.location.href = "login.html";
        return;
      }

      productorId = user.uid;
      localStorage.setItem("productorId", productorId);

      // âœ… asegurar doc de productor y leer plan
      await asegurarPlanProductor();
      renderAdminBox();
      iniciarPanel();
    });

    async function asegurarPlanProductor() {
      const ref = doc(db, "productores", productorId);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        await setDoc(ref, {
          plan: "free",
          creadoEn: serverTimestamp(),
          actualizadoEn: serverTimestamp()
        });
        planActual = "free";
      } else {
        planActual = (snap.data().plan || "free").toLowerCase();
      }

      // refrescar badge/estado en UI
      renderBannerPlan();
      aplicarBloqueosPorPlan();

    }

    function renderBannerPlan() {
      const t = document.getElementById("planTitulo");
      const s = document.getElementById("planSub");
      const btnAdmin = document.getElementById("btnSimularPro");
      const btnPlan = document.getElementById("btnProWhats");

      if (!t || !s) return;

      if (planActual === "pro") {
        t.textContent = "Plan: PRO âœ…";
        s.textContent = "Tracking de camiones y alertas a vecinos habilitadas.";
        btnAdmin && (btnAdmin.style.display = "none");

        if (btnPlan) btnPlan.textContent = "Volver a FREE";
      } else {
        t.textContent = "Plan: FREE ğŸ†“";
        s.textContent = "FREE bloquea: ğŸšš Camiones y ğŸ“² Alertas a vecinos. Pasate a PRO para habilitar seguridad total.";
        btnAdmin && (btnAdmin.style.display = "inline-block");

        if (btnPlan) btnPlan.textContent = "Pasar a PRO";
      }
    }

    document.getElementById("btnComoActivarPro")?.addEventListener("click", () => {
      alert(
        `âœ… CÃ³mo activar PRO ($50.000/mes)

1) RealizÃ¡ el pago por Mercado Pago / Transferencia.
2) Enviame el comprobante.
3) Te activo el plan PRO en el sistema.

ğŸ“Œ PRO habilita:
â€¢ ğŸšš Tracking de camiones en tiempo real
â€¢ ğŸ“² Alertas a vecinos
â€¢ Seguridad y control total

(En breve agregaremos pago automÃ¡tico.)`
      );
    });

    // âœ… botÃ³n oculto para pruebas: activar PRO
    document.getElementById("btnSimularPro")?.addEventListener("click", async () => {
      try {
        const ref = doc(db, "productores", productorId);
        await setDoc(ref, { plan: "pro", actualizadoEn: serverTimestamp() }, { merge: true });
        planActual = "pro";
        renderBannerPlan();
        alert("âœ… PRO activado (modo admin/prueba).");
      } catch (e) {
        console.error(e);
        alert("No se pudo activar PRO.");
      }
    });

    // =========================
    // âœ… WHATSAPP: solicitar PRO
    // =========================
    const NUMERO_WHATSAPP_PRO = "5492644429649"; // AR + 9 + 264... (sin 0 y sin 15)

    function abrirWhatsAppSolicitudPro() {
      const user = auth.currentUser;
      if (!user) {
        alert("TenÃ©s que iniciar sesiÃ³n para solicitar PRO.");
        return;
      }

      const uid = user.uid;
      const email = user.email || "sin-email";

      const texto =
        `Hola! Quiero activar PLAN PRO en Red Rural.\n` +
        `UID: ${uid}\n` +
        `Email: ${email}\n` +
        `Fecha: ${new Date().toLocaleString("es-AR")}\n` +
        `Plan actual: ${String(planActual || "free").toUpperCase()}`;

      const url = `https://wa.me/${NUMERO_WHATSAPP_PRO}?text=${encodeURIComponent(texto)}`;
      window.open(url, "_blank");
    }

    function abrirWhatsAppCancelarPro() {
      const user = auth.currentUser;
      if (!user) {
        alert("TenÃ©s que iniciar sesiÃ³n para solicitar la baja.");
        return;
      }

      const uid = user.uid;
      const email = user.email || "sin-email";

      const texto =
        `Hola! Quiero VOLVER A FREE (cancelar PRO) en Red Rural.\n` +
        `UID: ${uid}\n` +
        `Email: ${email}\n` +
        `Fecha: ${new Date().toLocaleString("es-AR")}\n` +
        `Plan actual: ${String(planActual || "free").toUpperCase()}`;

      const url = `https://wa.me/${NUMERO_WHATSAPP_PRO}?text=${encodeURIComponent(texto)}`;
      window.open(url, "_blank");
    }

    // BotÃ³n del banner (ya existe en tu HTML)
    document.getElementById("btnProWhats")?.addEventListener("click", () => {
      const esPro = String(planActual).toLowerCase() === "pro";

      if (!esPro) {
        // FREE â†’ solicitar PRO
        abrirWhatsAppSolicitudPro();
        return;
      }

      // PRO â†’ solicitar volver a FREE (cancelaciÃ³n)
      abrirWhatsAppCancelarPro();
    });


    function renderAdminBox() {
      const box = document.getElementById("adminProBox");
      if (!box) return;
      box.style.display = soyAdmin() ? "block" : "none";
    }

    async function setPlanUsuario(uid, nuevoPlan) {
      const ref = doc(db, "productores", uid);
      await setDoc(ref, { plan: nuevoPlan, actualizadoEn: serverTimestamp() }, { merge: true });
    }

    document.getElementById("adminActivarPro")?.addEventListener("click", async () => {
      try {
        if (!soyAdmin()) return alert("No sos admin.");
        const uid = document.getElementById("adminUidInput").value.trim();
        if (!uid) return alert("PegÃ¡ el UID del productor.");

        await setPlanUsuario(uid, "pro");
        alert("âœ… PRO habilitado para: " + uid);
      } catch (e) {
        console.error(e);
        alert("âŒ No se pudo activar PRO.");
      }
    });

    document.getElementById("adminPonerFree")?.addEventListener("click", async () => {
      try {
        if (!soyAdmin()) return alert("No sos admin.");
        const uid = document.getElementById("adminUidInput").value.trim();
        if (!uid) return alert("PegÃ¡ el UID del productor.");

        await setPlanUsuario(uid, "free");
        alert("âœ… Usuario vuelto a FREE: " + uid);
      } catch (e) {
        console.error(e);
        alert("âŒ No se pudo volver a FREE.");
      }
    });




    /* ============================================================
   ğŸ“Œ HOY â€” DASHBOARD (engagement diario)
   Lee Firestore y arma resumen para entrar todos los dÃ­as
============================================================ */

    function inicioDelDiaMs() {
      const d = new Date();
      d.setHours(0, 0, 0, 0);
      return d.getTime();
    }

    function hace24hMs() {
      return Date.now() - (24 * 60 * 60 * 1000);
    }

    function setHoyMsg(txt, ok = true) {
      const el = document.getElementById("hoyMsg");
      if (!el) return;
      el.textContent = txt;
      el.style.color = ok ? "#166534" : "#b91c1c";
      setTimeout(() => (el.textContent = ""), 3500);
    }

    function renderMiniItem(titulo, subtitulo) {
      return `
    <div class="item-simple" style="align-items:flex-start;">
      <div class="item-info">
        <strong>${titulo}</strong><br>
        <small>${subtitulo || ""}</small>
      </div>
      <span class="chip-categoria">HOY</span>
    </div>
  `;
    }

    async function actualizarHoy() {
      if (!productorId) return;

      const elEmp = document.getElementById("hoyEmpleados");
      const elPen = document.getElementById("hoyPendientes");
      const elAl24 = document.getElementById("hoyAlertas24");
      const elCam = document.getElementById("hoyCaminosMalos");
      const elOff = document.getElementById("hoyCamionesOff");

      const listaPend = document.getElementById("hoyListaPendientes");
      const listaAl = document.getElementById("hoyListaAlertas");

      const inicioMs = (() => { const d = new Date(); d.setHours(0, 0, 0, 0); return d.getTime(); })();
      const desde24 = Date.now() - (24 * 60 * 60 * 1000);

      try {
        // 1) Empleados (query por productorId)
        const qE = query(collection(db, "employees"), where("productorId", "==", productorId));
        const sE = await getDocs(qE);
        elEmp.textContent = sE.size;

        // 2) Tareas pendientes (query por productorId + completada)
        const qT = query(
          collection(db, "tareas"),
          where("productorId", "==", productorId),
          where("completada", "==", false)
        );
        const sT = await getDocs(qT);
        elPen.textContent = sT.size;

        // Pendientes crÃ­ticos (mÃ¡x 6)
        const pendientes = [];
        sT.forEach((d) => pendientes.push({ id: d.id, ...d.data() }));

        const prio = (p) => (p === "Alta" ? 3 : p === "Media" ? 2 : 1);
        pendientes.sort((a, b) => {
          const pa = prio(a.prioridad), pb = prio(b.prioridad);
          if (pb !== pa) return pb - pa;
          const ta = a.timestamp?.seconds || 0;
          const tb = b.timestamp?.seconds || 0;
          return tb - ta;
        });

        listaPend.innerHTML = "";
        if (pendientes.length === 0) {
          listaPend.innerHTML = `<small class="muted">âœ… No tenÃ©s pendientes. Excelente.</small>`;
        } else {
          pendientes.slice(0, 6).forEach((t) => {
            const cat = t.categoria ? `â€¢ ${t.categoria}` : "";
            const pr = t.prioridad ? `â€¢ ${t.prioridad}` : "";
            const emp = t.empleadoId ? `â€¢ DNI ${t.empleadoId}` : "â€¢ (sin asignar)";
            listaPend.innerHTML += `
          <div class="item-simple" style="align-items:flex-start;">
            <div class="item-info">
              <strong>ğŸ“ ${t.texto || "(sin texto)"}</strong><br>
              <small>${cat} ${pr} ${emp}</small>
            </div>
            <span class="chip-categoria">HOY</span>
          </div>
        `;
          });
        }

        // 3) Alertas 24h (query por productorId)
        const qA = query(
          collection(db, "alertas"),
          where("productorId", "==", productorId)
        );
        const sA = await getDocs(qA);

        let cant24 = 0;
        const alertas = [];
        sA.forEach((d) => {
          const a = d.data();
          const f = a.fecha || 0;
          if (f >= desde24) cant24++;
          alertas.push({ id: d.id, ...a });
        });

        elAl24.textContent = cant24;

        alertas.sort((a, b) => (b.fecha || 0) - (a.fecha || 0));
        listaAl.innerHTML = "";
        if (alertas.length === 0) {
          listaAl.innerHTML = `<small class="muted">Sin alertas todavÃ­a.</small>`;
        } else {
          alertas.slice(0, 6).forEach((a) => {
            const ft = a.fecha ? new Date(a.fecha).toLocaleString("es-AR") : "";
            listaAl.innerHTML += `
          <div class="item-simple" style="align-items:flex-start;">
            <div class="item-info">
              <strong>ğŸš¨ ${a.tipo || "Alerta"}</strong><br>
              <small>${a.descripcion || ""} â€¢ ${ft}</small>
            </div>
            <span class="chip-categoria">HOY</span>
          </div>
        `;
          });
        }

        // 4) Caminos â€œmalosâ€ hoy (complicado / intransitable)
        // OJO: caminos es read pÃºblico, pero igual filtramos por productorId para HOY
        const qC = query(
          collection(db, "caminos"),
          where("productorId", "==", productorId)
        );
        const sC = await getDocs(qC);

        let malos = 0;
        sC.forEach((d) => {
          const c = d.data();
          const f = c.fecha || 0;
          const est = (c.estado || "").toString().toLowerCase();
          if (f >= inicioMs && (est === "complicado" || est === "intransitable")) malos++;
        });
        elCam.textContent = malos;

        // 5) Camiones offline (query por productorId)
        const qM = query(
          collection(db, "camiones"),
          where("productorId", "==", productorId)
        );
        const sM = await getDocs(qM);

        let off = 0;
        sM.forEach((d) => {
          const c = d.data();
          if (c.online === false) off++;
        });
        elOff.textContent = off;

        // mensaje OK
        const el = document.getElementById("hoyMsg");
        if (el) {
          el.textContent = "âœ… HOY actualizado.";
          el.style.color = "#166534";
          setTimeout(() => (el.textContent = ""), 2500);
        }

      } catch (e) {
        console.error("Error actualizarHoy:", e);
        const el = document.getElementById("hoyMsg");
        if (el) {
          el.textContent = "âŒ No se pudo actualizar HOY (permisos/Ã­ndices).";
          el.style.color = "#b91c1c";
        }
      }
    }


    function initHoy() {
      const btn = document.getElementById("btnHoyRefrescar");
      btn?.addEventListener("click", actualizarHoy);

      // accesos rÃ¡pidos (usa el nav existente)
      document.getElementById("btnHoyIrTareas")?.addEventListener("click", () => {
        document.querySelector('[data-target="sec-tareas"]')?.click();
      });
      document.getElementById("btnHoyIrCaminos")?.addEventListener("click", () => {
        document.querySelector('[data-target="sec-caminos"]')?.click();
      });
      document.getElementById("btnHoyIrAlertas")?.addEventListener("click", () => {
        document.querySelector('[data-target="sec-alertas"]')?.click();
      });
      document.getElementById("btnHoyIrCamiones")?.addEventListener("click", () => {
        document.querySelector('[data-target="sec-camiones"]')?.click();
      });
    }


    // =========================
    // 2) NAVEGACIÃ“N ENTRE SECCIONES
    // =========================
    function navegar() {
      const botones = document.querySelectorAll(".nav-btn");
      const secciones = document.querySelectorAll("section");

      botones.forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.target;

          botones.forEach(b => b.classList.remove("activo"));
          btn.classList.add("activo");

          secciones.forEach(sec => {
            if (sec.id === target) {
              sec.classList.remove("hidden");
              setTimeout(() => sec.classList.add("visible"), 10);
            } else {
              sec.classList.remove("visible");
              setTimeout(() => sec.classList.add("hidden"), 150);
            }
          });

          // Mapas
          if (target === "sec-marcaciones-online") {
            setTimeout(() => {
              initMapaMarcaciones();
              actualizarMarcacionesMapa();
              if (mapaMarcaciones) mapaMarcaciones.invalidateSize();
            }, 200);
          }

          if (target === "sec-caminos") {
            setTimeout(() => {
              initMapaCaminos();
              if (mapaCaminos) mapaCaminos.invalidateSize();
            }, 200);
          }

          if (target === "sec-camiones") {
            setTimeout(() => {
              initMapaCamiones();
              if (mapaCamiones) mapaCamiones.invalidateSize();
            }, 200);
          }

          if (target === "sec-hoy") {
            setTimeout(() => actualizarHoy(), 150);
          }



        });
      });

      // estado inicial
      secciones.forEach(sec => sec.classList.add("hidden"));
      const primera = document.getElementById("sec-hoy");
      primera.classList.remove("hidden");
      primera.classList.add("visible");
    }

    navegar();


    function escucharViajesCamiones() {
      if (!productorId) return;

      const msgViajes = document.getElementById("msgViajes");
      const listaViajes = document.getElementById("listaViajes");
      if (!msgViajes || !listaViajes) return;

      msgViajes.style.color = "#4b5563";
      msgViajes.textContent = "Cargando recorridos...";

      const qV = query(
        collection(db, "viajes_camiones"),
        where("productorId", "==", productorId),
        orderBy("inicioMs", "desc")
      );

      onSnapshot(qV, (snap) => {
        listaViajes.innerHTML = "";

        if (snap.empty) {
          msgViajes.textContent = "TodavÃ­a no hay recorridos guardados.";
          return;
        }

        msgViajes.textContent = `Recorridos: ${snap.size}`;

        snap.forEach((d) => {
          const v = d.data();

          const ini = v.inicioMs ? new Date(v.inicioMs).toLocaleString("es-AR") : "â€”";
          const fin = v.finMs ? new Date(v.finMs).toLocaleString("es-AR") : "â€”";

          listaViajes.innerHTML += `
        <div class="item-simple">
          <div class="item-info">
            <strong>ğŸšš ${v.camionId || "â€”"}</strong><br>
            <small>Chofer DNI: ${v.empleadoDni || "â€”"}</small><br>
            <small>Inicio: ${ini}</small><br>
            <small>Fin: ${fin}</small><br>
            <small><b>Distancia:</b> ${fmtKm(v.distanciaM)} km</small>
          </div>
          <button class="btn-secundario" data-verviaje="${d.id}">Ver ruta</button>
        </div>
      `;
        });

        // âœ… Event delegation (mÃ¡s estable que agregar listeners uno por uno)
        listaViajes.onclick = (e) => {
          const btn = e.target.closest("button[data-verviaje]");
          if (!btn) return;

          const id = btn.getAttribute("data-verviaje");

          // buscar en el snap actual (sin hacer otro fetch)
          const doc = snap.docs.find(x => x.id === id);
          if (!doc) return;

          const v = doc.data();
          dibujarRutaGuardadaEnMapa(v);
        };

      }, (err) => {
        console.error("Snapshot viajes:", err);
        msgViajes.style.color = "#b91c1c";
        msgViajes.textContent = "Error cargando recorridos (reglas/Ã­ndices).";
      });
    }


    // =========================
    // 3) INICIO DEL PANEL
    // =========================
    function iniciarPanel() {
      cargarEmpleados();
      escucharTareas();
      escucharMarcacionesOnline();
      escucharVecinos();
      escucharVecinosParaAlertas();
      escucharAlertas();

      // âœ… AHORA sÃ­ (porque ya existe la funciÃ³n global)
      escucharCamiones();
      escucharViajesCamiones();
      initCalculadora();
      initClima();
      initHoy();
      actualizarHoy();


      setTimeout(() => {
        initMapaMarcaciones();
        initMapaCaminos();
      }, 300);

      setTimeout(() => marcarChipActivo("filtroTodos"), 350);

      document.getElementById("btnLimpiarRuta")?.addEventListener("click", () => {
        limpiarRutaGuardada();
      });
      document.getElementById("caminoEstado").dispatchEvent(new Event("change"));
    }



    /* ============================================================
   ğŸšš CAMIONES (TRACKING REALTIME)
============================================================ */
    let mapaCamiones = null;
    // âœ… Capa para â€œruta guardadaâ€ (recorrido histÃ³rico seleccionado)
    let capaRutaGuardada = null;
    let polyRutaGuardada = null;
    let markerInicio = null;
    let markerFin = null;
    let capaCamiones = null;
    const markersCamiones = new Map(); // camionId -> marker
    // ğŸ§­ RUTAS (recorrido) por camiÃ³n
    let capaRutasCamiones = null;

    // camionId -> { latlngs: [ [lat,lng], ... ], polyline: L.Polyline }
    const rutasCamiones = new Map();

    // (opcional) para no llenar de puntos si manda muy seguido
    const UMBRAL_METROS_RUTA = 20;     // agrega punto si se moviÃ³ +20m
    const MAX_PUNTOS_RUTA = 800;       // lÃ­mite por camiÃ³n (performance)


    function initMapaCamiones() {
      // âœ… si el div no estÃ¡, salimos sin romper
      const mapDiv = document.getElementById("mapCamiones");
      if (!mapDiv) return;

      if (mapaCamiones) return;

      mapaCamiones = L.map("mapCamiones").setView([-33, -59.3], 10);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaCamiones);

      // âœ… primero rutas, despuÃ©s marcadores (para que el marker quede arriba)
      capaRutasCamiones = L.layerGroup().addTo(mapaCamiones);
      capaCamiones = L.layerGroup().addTo(mapaCamiones);
      // âœ… capa para ruta guardada (arriba del tile, debajo de markers)
      if (!capaRutaGuardada) capaRutaGuardada = L.layerGroup().addTo(mapaCamiones);

    }


    function renderCamionItem(c) {
      const upd = c.lastSeen ? new Date(c.lastSeen).toLocaleString("es-AR") : "â€”";
      const onlineTxt = c.online ? "ğŸŸ¢ Online" : "ğŸ”´ Offline";
      const accTxt = (c.accuracy != null) ? `â€¢ Â±${c.accuracy}m` : "";
      return `
    <div class="item-simple">
      <div class="item-info">
        <strong>ğŸšš ${c.camionId ?? "(sin ID)"}</strong><br>
        <small>Chofer DNI: ${c.empleadoDni ?? "â€”"}</small><br>
        <small>${onlineTxt} â€¢ Ãšltimo ping: ${upd} ${accTxt}</small>
      </div>
      <button class="btn-secundario" data-zoom="${c.camionId ?? ""}">Ver</button>
    </div>
  `;
    }

    function distMetros(lat1, lng1, lat2, lng2) {
      // Haversine
      const R = 6371000;
      const toRad = (x) => (x * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);

      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function upsertRutaCamion(camionId, lat, lng) {
      if (!mapaCamiones || !capaRutasCamiones) return;

      const key = camionId;
      if (!rutasCamiones.has(key)) {
        const latlngs = [[lat, lng]];
        const poly = L.polyline(latlngs, {
          weight: 4,
          opacity: 0.9
        }).addTo(capaRutasCamiones);

        rutasCamiones.set(key, { latlngs, polyline: poly });
        return;
      }

      const obj = rutasCamiones.get(key);
      const last = obj.latlngs[obj.latlngs.length - 1];
      const d = distMetros(last[0], last[1], lat, lng);

      // âœ… evita agregar puntos â€œpegadosâ€ (ruido GPS)
      if (d < UMBRAL_METROS_RUTA) return;

      obj.latlngs.push([lat, lng]);

      // âœ… lÃ­mite por rendimiento
      if (obj.latlngs.length > MAX_PUNTOS_RUTA) {
        obj.latlngs.splice(0, obj.latlngs.length - MAX_PUNTOS_RUTA);
      }

      obj.polyline.setLatLngs(obj.latlngs);
    }

    function borrarRutaCamion(camionId) {
      const obj = rutasCamiones.get(camionId);
      if (!obj) return;
      if (capaRutasCamiones) capaRutasCamiones.removeLayer(obj.polyline);
      rutasCamiones.delete(camionId);
    }


    function upsertMarkerCamion(c) {
      if (!mapaCamiones || !capaCamiones) return;

      const camionId = c.camionId;
      if (!camionId) return;

      if (typeof c.lat !== "number" || typeof c.lng !== "number") return;

      // âœ… dibujar recorrido
      upsertRutaCamion(camionId, c.lat, c.lng);

      const popup = `
    <b>ğŸšš ${camionId}</b><br>
    Chofer: ${c.empleadoDni ?? "â€”"}<br>
    Estado: ${c.online ? "ğŸŸ¢ Online" : "ğŸ”´ Offline"}<br>
    PrecisiÃ³n: ${c.accuracy ?? "â€”"} m
  `;

      if (markersCamiones.has(camionId)) {
        const m = markersCamiones.get(camionId);
        m.setLatLng([c.lat, c.lng]);
        m.setPopupContent(popup);
      } else {
        const m = L.marker([c.lat, c.lng]).addTo(capaCamiones);
        m.bindPopup(popup);
        markersCamiones.set(camionId, m);
      }
    }

    function limpiarMarkersNoPresentes(setIdsActuales) {
      for (const [id, marker] of markersCamiones.entries()) {
        if (!setIdsActuales.has(id)) {
          capaCamiones.removeLayer(marker);
          markersCamiones.delete(id);

          // âœ… borrar ruta tambiÃ©n
          borrarRutaCamion(id);
        }
      }
    }

    function fmtKm(m) {
      const km = (m || 0) / 1000;
      return km.toFixed(2).replace(".", ",");
    }

   

    function escucharCamiones() {
      if (!productorId) return;

      const msgCamiones = document.getElementById("msgCamiones");
      const listaCamiones = document.getElementById("listaCamiones");

      // âœ… Guard: si no existe la secciÃ³n, no rompas
      if (!msgCamiones || !listaCamiones) {
        console.warn("Faltan elementos de Camiones (msgCamiones/listaCamiones).");
        return;
      }

      const qC = query(collection(db, "camiones"), where("productorId", "==", productorId));

      onSnapshot(qC, (snap) => {
        initMapaCamiones();

        listaCamiones.innerHTML = "";
        msgCamiones.style.color = "#4b5563";

        if (snap.empty) {
          msgCamiones.textContent = "No hay camiones transmitiendo todavÃ­a.";
          if (capaCamiones) capaCamiones.clearLayers();
          markersCamiones.clear();
          return;
          if (capaRutasCamiones) capaRutasCamiones.clearLayers();
          rutasCamiones.clear();

        }

        const idsActuales = new Set();
        const camiones = [];

        snap.forEach((d) => {
          const c = d.data();
          camiones.push(c);
          if (c.camionId) idsActuales.add(c.camionId);
          upsertMarkerCamion(c);
        });

        limpiarMarkersNoPresentes(idsActuales);

        camiones
          .sort((a, b) => (b.lastSeen || 0) - (a.lastSeen || 0))
          .forEach((c) => {
            listaCamiones.innerHTML += renderCamionItem(c);
          });

        msgCamiones.textContent = `Camiones encontrados: ${camiones.length}`;

        listaCamiones.querySelectorAll("button[data-zoom]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-zoom");
            const marker = markersCamiones.get(id);
            if (!marker) return;
            mapaCamiones.setView(marker.getLatLng(), 16, { animate: true });
            marker.openPopup();
          });
        });

      }, (err) => {
        console.error("Snapshot camiones:", err);
        msgCamiones.style.color = "#b91c1c";
        msgCamiones.textContent = "Error escuchando camiones (permisos/reglas/Ã­ndices).";
      });
    }

    function limpiarRutaGuardada() {
      if (!capaRutaGuardada) return;
      capaRutaGuardada.clearLayers();
      polyRutaGuardada = null;
      markerInicio = null;
      markerFin = null;
    }

    function dibujarRutaGuardadaEnMapa(viaje) {
      initMapaCamiones();
      if (!mapaCamiones || !capaRutaGuardada) return;

      limpiarRutaGuardada();

      const ruta = Array.isArray(viaje.ruta) ? viaje.ruta : [];
      if (ruta.length < 2) {
        alert("Este recorrido no tiene suficientes puntos para dibujar.");
        return;
      }

      // ruta guardada viene como: [{lat,lng,t}, ...]
      const latlngs = ruta
        .filter(p => typeof p.lat === "number" && typeof p.lng === "number")
        .map(p => [p.lat, p.lng]);

      if (latlngs.length < 2) {
        alert("Recorrido invÃ¡lido.");
        return;
      }

      // âœ… Polyline del recorrido guardado
      polyRutaGuardada = L.polyline(latlngs, {
        weight: 5,
        opacity: 0.95,
        dashArray: "10 8" // se distingue del tracking en vivo
      }).addTo(capaRutaGuardada);

      // âœ… Inicio y fin
      const ini = latlngs[0];
      const fin = latlngs[latlngs.length - 1];

      markerInicio = L.circleMarker(ini, { radius: 7, weight: 2 }).addTo(capaRutaGuardada);
      markerFin = L.circleMarker(fin, { radius: 7, weight: 2 }).addTo(capaRutaGuardada);

      const km = viaje.distanciaM ? (viaje.distanciaM / 1000) : null;

      markerInicio.bindPopup(`ğŸŸ¢ Inicio<br>ğŸšš ${viaje.camionId || "â€”"}<br>ğŸ‘¤ DNI: ${viaje.empleadoDni || "â€”"}`);
      markerFin.bindPopup(`ğŸ”´ Fin<br>${km != null ? `ğŸ“ ${km.toFixed(2)} km` : ""}`);

      // âœ… Zoom automÃ¡tico a toda la ruta
      mapaCamiones.fitBounds(polyRutaGuardada.getBounds(), { padding: [20, 20] });

      // opcional: abrir popup inicio
      markerInicio.openPopup();
    }


    /* ============================================================
       EMPLEADOS (FIREBASE)
    ============================================================ */
    const msgEmpleado = document.getElementById("msgEmpleado");
    const listaEmpleados = document.getElementById("listaEmpleados");

    async function cargarEmpleados() {
      if (!productorId) return;

      listaEmpleados.innerHTML = "<small>Cargando...</small>";

      const ref = collection(db, "employees");
      const q = query(ref, where("productorId", "==", productorId));
      const snap = await getDocs(q);

      listaEmpleados.innerHTML = "";
      if (snap.empty) {
        listaEmpleados.innerHTML = "<small>No hay empleados cargados.</small>";
      }

      snap.forEach(s => {
        const e = s.data();
        const item = document.createElement("div");
        item.className = "item-simple";

        item.innerHTML = `
          <div class="item-info">
            <strong>ğŸ‘· ${e.dni}</strong><br>
            <small>${e.nombre ?? ""}</small>
          </div>
          <span class="chip chip-verde">Activo</span>
        `;

        listaEmpleados.appendChild(item);
      });

      // cargar select tareas
      const sel = document.getElementById("tareaEmpleado");
      sel.innerHTML = `<option value="">(sin asignar)</option>`;
      snap.forEach(s => {
        const e = s.data();
        sel.innerHTML += `<option value="${e.dni}">${e.dni}</option>`;
      });
    }

    document.getElementById("btnAgregarEmpleado").addEventListener("click", async () => {
      const nombre = document.getElementById("empNombre").value.trim();
      const dni = document.getElementById("empDni").value.trim().replace(/\D/g, "");
      const telefono = document.getElementById("empTelefono").value.trim();
      const clave = document.getElementById("empClave").value.trim(); // âœ… clave Firestore

      if (!nombre || !dni || !telefono || !clave) {
        msgEmpleado.textContent = "âš ï¸ CompletÃ¡ todos los campos.";
        msgEmpleado.style.color = "#b91c1c";
        return;
      }

      try {
        // âœ… Guardar empleado por DNI (docId = DNI)
        await setDoc(doc(db, "employees", dni), {
          productorId,
          nombre,
          dni,
          telefono,
          clave,          // âœ… se guarda en Firestore
          activo: true,
          timestamp: serverTimestamp(),
          authUid: null   // opcional, por compatibilidad con rules
        });

        msgEmpleado.style.color = "#166534";
        msgEmpleado.textContent = "âœ… Empleado agregado (Firestore).";

        document.getElementById("empNombre").value = "";
        document.getElementById("empDni").value = "";
        document.getElementById("empTelefono").value = "";
        document.getElementById("empClave").value = "";

        cargarEmpleados();
      } catch (e) {
        console.error(e);
        msgEmpleado.style.color = "#b91c1c";
        msgEmpleado.textContent = "âŒ Error al registrar empleado.";
      }
    });


    /* ============================================================
       TAREAS
    ============================================================ */
    const listaTareas = document.getElementById("listaTareas");
    const msgTareas = document.getElementById("msgTareas");

    document.getElementById("btnAgregarTarea").addEventListener("click", agregarTarea);

    async function agregarTarea() {
      const texto = document.getElementById("nuevaTareaTexto").value.trim();
      const categoria = document.getElementById("tareaCategoria").value;
      const prioridad = document.getElementById("tareaPrioridad").value;
      const empleadoId = document.getElementById("tareaEmpleado").value || null;

      if (!texto) {
        msgTareas.textContent = "âš ï¸ EscribÃ­ la tarea.";
        msgTareas.style.color = "#b91c1c";
        return;
      }

      await addDoc(collection(db, "tareas"), {
        productorId,
        texto,
        categoria,
        prioridad,
        empleadoId,
        completada: false,
        timestamp: serverTimestamp()
      });

      document.getElementById("nuevaTareaTexto").value = "";
      msgTareas.style.color = "#166534";
      msgTareas.textContent = "âœ… Tarea guardada.";
    }

    function escucharTareas() {
      if (!productorId) return;
      const qT = query(collection(db, "tareas"), where("productorId", "==", productorId));

      onSnapshot(qT, snap => {
        listaTareas.innerHTML = "";
        if (snap.empty) {
          listaTareas.innerHTML = "<small>No hay tareas.</small>";
          return;
        }

        snap.forEach(docSnap => {
          const t = docSnap.data();

          const item = document.createElement("div");
          item.className = "item-simple";

          item.innerHTML = `
            <div class="item-info">
              <strong>${t.texto}</strong><br>
              <span class="chip-categoria">${t.categoria}</span>
              <span class="chip-prioridad-${t.prioridad.toLowerCase()}">${t.prioridad}</span><br>
              <small>Asignado a: ${t.empleadoId ?? "(sin asignar)"}</small><br>
              <small>${t.completada ? "âœ” Completada" : "Pendiente"}</small>
            </div>
          `;

          const btn = document.createElement("button");
          btn.className = "btn-secundario";
          btn.textContent = t.completada ? "Marcar pendiente" : "Marcar hecha";
          btn.addEventListener("click", async () => {
            await updateDoc(doc(db, "tareas", docSnap.id), {
              completada: !t.completada
            });
          });

          item.appendChild(btn);
          listaTareas.appendChild(item);
        });
      });
    }

    /* ============================================================
       MAPA MARCACIONES (simple)
    ============================================================ */
    let mapaMarcaciones = null;
    let capaMarcadores = null;
    let marcacionesOnline = [];

    function initMapaMarcaciones() {
      // âœ… si el div no estÃ¡, no inicializamos (evita Map container not found)
      const mapDiv = document.getElementById("mapMarcaciones");
      if (!mapDiv) return;

      if (mapaMarcaciones) return;

      mapaMarcaciones = L.map("mapMarcaciones").setView([-33, -59.3], 10);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaMarcaciones);
      capaMarcadores = L.layerGroup().addTo(mapaMarcaciones);

      // âœ… cuando se muestra la secciÃ³n, Leaflet necesita recalcular tamaÃ±os
      setTimeout(() => mapaMarcaciones.invalidateSize(), 350);
    }


    function actualizarMarcacionesMapa() {
      if (!mapaMarcaciones || !capaMarcadores) return;
      capaMarcadores.clearLayers();
      marcacionesOnline.forEach(m => {
        if (!m.lat || !m.lng) return;
        L.marker([m.lat, m.lng]).addTo(capaMarcadores);
      });
    }

    function escucharMarcacionesOnline() {
      if (!productorId) return;
      const qM = query(collection(db, "marcaciones"), where("productorId", "==", productorId));

      onSnapshot(qM, snap => {
        marcacionesOnline = [];

        snap.forEach(s => {
          const d = s.data();
          marcacionesOnline.push({
            lat: Number(d.lat),
            lng: Number(d.lng),
            fechaNum: d.timestamp?.seconds ?? 0,
            dni: d.dni,
            tipo: d.tipo
          });
        });

        actualizarMarcacionesMapa();
      });
    }

    /* ============================================================
       CAMINOS (Puntos + Tramos + Filtros + Alias)
    ============================================================ */
    let mapaCaminos = null;
    let modoCamino = "punto";
    let tramoActual = [];

    let capaTramos = null;
    let capaPuntosCaminos = null;

    let filtroEstado = "todos";
    let unsubscribeCaminos = null; // âœ… evita listeners duplicados

    const coloresCamino = {
      transitable: "#16a34a",
      complicado: "#eab308",
      intransitable: "#dc2626"
    };

    // ===============================
    // ğŸ“ GPS: centrar mapa + arrancar donde estÃ¡s
    // ===============================
    let miUbicacionMarker = null;

    function pedirUbicacionActual(opts = { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 }) {
      return new Promise((resolve, reject) => {
        if (!("geolocation" in navigator)) {
          reject(new Error("GeolocalizaciÃ³n no disponible en este dispositivo."));
          return;
        }
        navigator.geolocation.getCurrentPosition(resolve, reject, opts);
      });
    }

    async function centrarEnMiUbicacion() {
      try {
        mostrarMensaje("ğŸ“¡ Buscando tu ubicaciÃ³n...", "#14532d");

        const pos = await pedirUbicacionActual();
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = Math.round(pos.coords.accuracy || 0);

        if (!mapaCaminos) return;

        // mover el mapa
        mapaCaminos.setView([lat, lng], 15, { animate: true });

        // marcador de mi ubicaciÃ³n (solo visual)
        if (miUbicacionMarker) {
          miUbicacionMarker.setLatLng([lat, lng]);
        } else {
          miUbicacionMarker = L.circleMarker([lat, lng], {
            radius: 8,
            weight: 2,
            color: "#111827",
            fillOpacity: 0.95
          }).addTo(mapaCaminos);

          miUbicacionMarker.bindPopup(`ğŸ“ EstÃ¡s acÃ¡<br><small>PrecisiÃ³n aprox: ${acc} m</small>`);
        }

        mostrarMensaje("âœ… UbicaciÃ³n encontrada", "#166534");
      } catch (e) {
        console.error("GPS error:", e);
        mostrarMensaje("âŒ No pude obtener tu ubicaciÃ³n. ActivÃ¡ GPS y permisos.", "#b91c1c");
      }
    }


    function initMapaCaminos() {
      if (mapaCaminos) return;
      if (!productorId) return;

      // âœ… si el div no estÃ¡, salimos sin romper
      const mapDiv = document.getElementById("mapCaminos");
      if (!mapDiv) return;

      mapaCaminos = L.map("mapCaminos").setView([-33, -59.3], 10);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapaCaminos);

      capaTramos = L.layerGroup().addTo(mapaCaminos);
      capaPuntosCaminos = L.layerGroup().addTo(mapaCaminos);

      mapaCaminos.on("click", manejarClickMapa);

      cargarCaminosGuardados();
      setTimeout(() => mapaCaminos.invalidateSize(), 400);

      // âš ï¸ si querÃ©s auto-centrar, lo hacemos SOLO cuando el mapa ya existe:
      // setTimeout(() => centrarEnMiUbicacion(), 600);
    }


    // âœ… intentar centrar automÃ¡ticamente al iniciar el mapa (si el usuario permite)
    // setTimeout(() => centrarEnMiUbicacion(), 600);


    const btnModoPunto = document.getElementById("btnModoPunto");
    const btnModoTramo = document.getElementById("btnModoTramo");
    const btnGuardarTramo = document.getElementById("btnGuardarTramo");
    const btnCentrar = document.getElementById("btnCentrarUbicacion");
    if (btnCentrar) btnCentrar.onclick = () => centrarEnMiUbicacion();


    btnModoPunto.onclick = () => {
      modoCamino = "punto";
      btnGuardarTramo.style.display = "none";
      tramoActual = [];
      if (capaTramos) capaTramos.clearLayers();
    };

    btnModoTramo.onclick = () => {
      modoCamino = "tramo";
      tramoActual = [];
      btnGuardarTramo.style.display = "inline-block";
      if (capaTramos) capaTramos.clearLayers();
    };

    function manejarClickMapa(e) {
      const estado = document.getElementById("caminoEstado").value;
      const latlng = [e.latlng.lat, e.latlng.lng];

      if (modoCamino === "punto") guardarPunto(latlng, estado);
      if (modoCamino === "tramo") {
        tramoActual.push(latlng);
        dibujarTramoTemporal();
      }
    }

    async function guardarPunto(latlng, estado) {
      const alias = prompt("Nombre del lugar (opcional): ej. Puente, Entrada Potrero 3")?.trim() || "";

      try {
        await addDoc(collection(db, "caminos"), {
          productorId,
          tipo: "punto",
          estado,
          alias,
          lat: latlng[0],
          lng: latlng[1],
          fecha: Date.now(),
          timestamp: serverTimestamp()
        });

        mostrarMensaje("âœ… Punto guardado", "#166534");
      } catch (err) {
        console.error(err);
        mostrarMensaje("âŒ Error al guardar el punto", "#b91c1c");
      }
    }

    btnGuardarTramo.onclick = async () => {
      const estado = document.getElementById("caminoEstado").value;

      if (tramoActual.length < 2) {
        mostrarMensaje("âš ï¸ NecesitÃ¡s al menos 2 puntos para un tramo", "#b91c1c");
        return;
      }

      try {
        const alias = prompt("Nombre del tramo (opcional): ej. Camino al galpÃ³n")?.trim() || "";

        await addDoc(collection(db, "caminos"), {
          productorId,
          tipo: "tramo",
          estado,
          alias,
          puntos: tramoActual,
          fecha: Date.now(),
          timestamp: serverTimestamp()
        });

        tramoActual = [];
        if (capaTramos) capaTramos.clearLayers();

        mostrarMensaje("âœ… Tramo guardado", "#166534");
      } catch (err) {
        console.error(err);
        mostrarMensaje("âŒ Error al guardar tramo", "#b91c1c");
      }
    };

    function dibujarTramoTemporal() {
      if (!capaTramos) return;
      capaTramos.clearLayers();

      if (tramoActual.length >= 2) {
        L.polyline(tramoActual, {
          color: "#6b7280",
          weight: 3,
          dashArray: "6,4"
        }).addTo(capaTramos);
      }
    }

    function marcarChipActivo(id) {
      document.querySelectorAll(".filtro-chip").forEach(c => c.classList.remove("activo"));
      document.getElementById(id).classList.add("activo");
    }

    document.getElementById("filtroTodos").onclick = () => {
      filtroEstado = "todos";
      marcarChipActivo("filtroTodos");
      cargarCaminosGuardados();
    };
    document.getElementById("filtroTransitable").onclick = () => {
      filtroEstado = "transitable";
      marcarChipActivo("filtroTransitable");
      cargarCaminosGuardados();
    };
    document.getElementById("filtroComplicado").onclick = () => {
      filtroEstado = "complicado";
      marcarChipActivo("filtroComplicado");
      cargarCaminosGuardados();
    };
    document.getElementById("filtroIntransitable").onclick = () => {
      filtroEstado = "intransitable";
      marcarChipActivo("filtroIntransitable");
      cargarCaminosGuardados();
    };

    // âœ… ESTA ES LA FUNCIÃ“N CLAVE (corrigida)
    function cargarCaminosGuardados() {
      if (!productorId) return;
      if (!capaPuntosCaminos || !capaTramos) return;

      // âœ… evita mÃºltiples listeners cada vez que tocÃ¡s un filtro
      if (typeof unsubscribeCaminos === "function") unsubscribeCaminos();

      const q = query(
        collection(db, "caminos"),
        where("productorId", "==", productorId)
      );

      unsubscribeCaminos = onSnapshot(q, (snap) => {
        capaPuntosCaminos.clearLayers();
        capaTramos.clearLayers();

        snap.forEach((docSnap) => {
          const d = docSnap.data();

          if (filtroEstado !== "todos" && d.estado !== filtroEstado) return;

          const color = coloresCamino[d.estado];
          const fechaTxt = new Date(d.fecha).toLocaleString("es-AR");

          if (d.tipo === "punto") {
            const marker = L.circleMarker([d.lat, d.lng], {
              radius: 9,
              color: "#1f2937",
              weight: 2,
              fillColor: color,
              fillOpacity: 0.95
            }).addTo(capaPuntosCaminos);

            const aliasTxt = d.alias ? `<b>ğŸ“ ${d.alias}</b><br>` : "";
            const titulo = d.alias ? `ğŸ“ ${d.alias}` : formaEstado(d.estado);

            marker.bindTooltip(titulo, {
              direction: "top",
              offset: [0, -12],
              opacity: 0.9,
              className: "tooltip-camino"
            });

            const latTxt = Number(d.lat).toFixed(6);
            const lngTxt = Number(d.lng).toFixed(6);
            const gmaps = `https://www.google.com/maps?q=${latTxt},${lngTxt}`;

            marker.bindPopup(`
              ${aliasTxt}
              <b>${formaEstado(d.estado)}</b><br>
              ${fechaTxt}<br>
              <small>Punto</small><br>
              <small><b>Coord:</b> ${latTxt}, ${lngTxt}</small><br><br>

              <button onclick="copiarCoord('${latTxt},${lngTxt}')">ğŸ“‹ Copiar coord</button>
              <a href="${gmaps}" target="_blank">ğŸ§­ Abrir Maps</a>
              <br><br>

              <button onclick="cambiarEstadoCamino('${docSnap.id}')">Cambiar estado</button>
              <button onclick="borrarCamino('${docSnap.id}')">ğŸ—‘ï¸ Eliminar</button>

            `);
          }

          if (d.tipo === "tramo") {
            const poly = L.polyline(d.puntos, {
              color,
              weight: d.estado === "intransitable" ? 6 : d.estado === "complicado" ? 5 : 4,
              opacity: 0.9,
              dashArray: d.estado === "complicado" ? "6,4" : null
            }).addTo(capaTramos);

            const tituloTramo = d.alias ? `ğŸ›£ï¸ ${d.alias}` : formaEstado(d.estado);

            poly.bindTooltip(tituloTramo, {
              direction: "center",
              opacity: 0.9,
              className: "tooltip-camino"
            });

            const p0 = d.puntos?.[0];
            const p1 = d.puntos?.[d.puntos.length - 1];

            const ini = p0 ? `${Number(p0[0]).toFixed(6)}, ${Number(p0[1]).toFixed(6)}` : "-";
            const fin = p1 ? `${Number(p1[0]).toFixed(6)}, ${Number(p1[1]).toFixed(6)}` : "-";

            const distKm = calcularDistanciaTramoKM(d.puntos || []);
            const aliasTxt = d.alias ? `<b>ğŸ›£ï¸ ${d.alias}</b><br>` : "";

            poly.bindPopup(`
              ${aliasTxt}
              <b>${formaEstado(d.estado)}</b><br>
              ${fechaTxt}<br>
              <small>Tramo</small><br>
              <small><b>Inicio:</b> ${ini}</small><br>
              <small><b>Fin:</b> ${fin}</small><br>
              <small><b>Dist:</b> ${distKm.toFixed(2)} km</small><br><br>

              <button onclick="copiarCoord('${ini}')">ğŸ“‹ Copiar inicio</button>
              <button onclick="copiarCoord('${fin}')">ğŸ“‹ Copiar fin</button>
              <br><br>

              <button onclick="cambiarEstadoCamino('${docSnap.id}')">Cambiar estado</button>
            `);
          }
        });

      }, (err) => {
        console.error("Error escuchando caminos:", err);
        mostrarMensaje("âŒ Sin permisos para leer caminos. RevisÃ¡ reglas Firestore.", "#b91c1c");
      });
    }

    function formaEstado(e) {
      return e === "transitable" ? "ğŸŸ¢ Transitable"
        : e === "complicado" ? "ğŸŸ¡ Complicado"
          : "ğŸ”´ Intransitable";
    }

    function haversineKM(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function calcularDistanciaTramoKM(puntos) {
      if (!Array.isArray(puntos) || puntos.length < 2) return 0;
      let total = 0;
      for (let i = 1; i < puntos.length; i++) {
        const [lat1, lon1] = puntos[i - 1];
        const [lat2, lon2] = puntos[i];
        total += haversineKM(lat1, lon1, lat2, lon2);
      }
      return total;
    }

    // funciones globales para el popup
    window.cambiarEstadoCamino = async (id) => {
      const nuevo = prompt("Nuevo estado: transitable / complicado / intransitable");
      if (!["transitable", "complicado", "intransitable"].includes(nuevo)) {
        alert("Estado invÃ¡lido");
        return;
      }
      await updateDoc(doc(db, "caminos", id), { estado: nuevo });
    };

    window.borrarCamino = async (id) => {
      if (!confirm("Â¿Eliminar este punto/tramo de camino?")) return;
      try {
        await deleteDoc(doc(db, "caminos", id));
        mostrarMensaje("ğŸ—‘ï¸ Camino eliminado", "#b91c1c");
      } catch (e) {
        console.error("Error borrando camino:", e);
        alert("No se pudo eliminar (revisÃ¡ permisos/reglas).");
      }
    };


    window.copiarCoord = async (txt) => {
      try {
        await navigator.clipboard.writeText(txt);
        mostrarMensaje("âœ… Coordenadas copiadas: " + txt, "#166534");
      } catch (e) {
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        mostrarMensaje("âœ… Coordenadas copiadas: " + txt, "#166534");
      }
    };

    // borrar caminos de hoy (solo del productor)
    document.getElementById("btnBorrarMisCaminosHoy").onclick = async () => {
      if (!confirm("Â¿Borrar SOLO tus caminos del dÃ­a de hoy?")) return;

      const inicio = new Date();
      inicio.setHours(0, 0, 0, 0);
      const inicioMs = inicio.getTime();

      const q = query(
        collection(db, "caminos"),
        where("productorId", "==", productorId)
      );

      const snap = await getDocs(q);

      const batch = writeBatch(db);
      snap.forEach(docSnap => {
        const d = docSnap.data();
        if (d.fecha >= inicioMs) batch.delete(docSnap.ref);
      });

      await batch.commit();
      mostrarMensaje("âœ… Se borraron tus caminos de HOY", "#166534");
    };

    function mostrarMensaje(msg, color = "#000") {
      const div = document.getElementById("msgCaminos");
      if (!div) return;
      div.textContent = msg;
      div.style.color = color;
      setTimeout(() => div.textContent = "", 3500);
    }

    document.getElementById("caminoEstado").addEventListener("change", e => {
      const est = e.target.value;
      const prev = document.getElementById("estadoPreview");

      if (est === "transitable") { prev.textContent = "ğŸŸ¢ Transitable"; prev.style.background = "#dcfce7"; }
      if (est === "complicado") { prev.textContent = "ğŸŸ¡ Complicado"; prev.style.background = "#fef9c3"; }
      if (est === "intransitable") { prev.textContent = "ğŸ”´ Intransitable"; prev.style.background = "#fee2e2"; }
    });

    /* ============================================================
       VECINOS (FIRESTORE) âœ…
       ColecciÃ³n: "vecinos"
       Campos: productorId, nombre, telefono, timestamp
    ============================================================ */

    const msgVecinos = document.getElementById("msgVecinos");
    const listaVecinos = document.getElementById("listaVecinos");

    function normalizarTel(tel) {
      // deja solo nÃºmeros, Ãºtil para wa.me
      return (tel || "").toString().replace(/\D/g, "");
    }

    function validarTelAR(tel) {
      // No es obligatorio, pero ayuda.
      // En Argentina suele ser 549 + cÃ³digo Ã¡rea + nÃºmero (10 a 13 dÃ­gitos aprox)
      return tel.length >= 10;
    }

    function mostrarMsg(el, texto, color = "#14532d", ms = 3500) {
      if (!el) return;
      el.textContent = texto;
      el.style.color = color;
      if (ms) setTimeout(() => el.textContent = "", ms);
    }

    async function agregarVecino() {
      const nombre = document.getElementById("vecinoNombre").value.trim();
      const telRaw = document.getElementById("vecinoTelefono").value.trim();
      const telefono = normalizarTel(telRaw);

      if (!productorId) return;

      if (!nombre || !telefono) {
        mostrarMsg(msgVecinos, "âš ï¸ CompletÃ¡ nombre y telÃ©fono.", "#b91c1c");
        return;
      }

      if (!validarTelAR(telefono)) {
        mostrarMsg(msgVecinos, "âš ï¸ TelÃ©fono invÃ¡lido. UsÃ¡ formato numÃ©rico (ej: 5493444xxxxxx).", "#b91c1c");
        return;
      }

      try {
        // Usamos el telÃ©fono como ID del documento para evitar duplicados
        await setDoc(doc(db, "vecinos", `${productorId}_${telefono}`), {
          productorId,
          nombre,
          telefono,
          timestamp: serverTimestamp()
        });

        mostrarMsg(msgVecinos, "âœ… Vecino agregado correctamente.", "#166534");

        document.getElementById("vecinoNombre").value = "";
        document.getElementById("vecinoTelefono").value = "";
      } catch (e) {
        console.error("Error al agregar vecino:", e);
        mostrarMsg(msgVecinos, "âŒ No se pudo agregar el vecino (revisÃ¡ permisos/reglas).", "#b91c1c", 5000);
      }
    }

    function escucharVecinos() {
      if (!productorId) return;

      const qV = query(
        collection(db, "vecinos"),
        where("productorId", "==", productorId)
      );

      onSnapshot(qV, (snap) => {
        listaVecinos.innerHTML = "";

        if (snap.empty) {
          listaVecinos.innerHTML = "<small>No hay vecinos cargados.</small>";
          return;
        }

        snap.forEach((docSnap) => {
          const v = docSnap.data();

          const item = document.createElement("div");
          item.className = "item-simple";

          item.innerHTML = `
        <div class="item-info">
          <strong>ğŸ¤ ${v.nombre || ""}</strong><br>
          <small>${v.telefono || ""}</small>
        </div>
      `;

          // WhatsApp
          const btnWA = document.createElement("a");
          btnWA.className = "btn-secundario";
          btnWA.textContent = "WhatsApp";
          btnWA.href = `https://wa.me/${normalizarTel(v.telefono)}?text=${encodeURIComponent(
            "Hola " + (v.nombre || "") + ", te contacto desde Red Rural."
          )}`;
          btnWA.target = "_blank";

          // Editar
          const btnEdit = document.createElement("button");
          btnEdit.className = "btn-secundario";
          btnEdit.textContent = "Editar";
          btnEdit.onclick = () => editarVecino(docSnap.id, v);

          // Eliminar
          const btnDel = document.createElement("button");
          btnDel.className = "btn-secundario";
          btnDel.textContent = "Eliminar";
          btnDel.onclick = () => eliminarVecino(docSnap.id, v);

          item.appendChild(btnWA);
          item.appendChild(btnEdit);
          item.appendChild(btnDel);

          listaVecinos.appendChild(item);
        });

      }, (err) => {
        console.error("Error escuchando vecinos:", err);
        listaVecinos.innerHTML = "<small>âŒ Sin permisos para leer vecinos (revisÃ¡ reglas).</small>";
      });
    }


    async function eliminarVecino(docId, v) {
      if (!confirm(`Â¿Eliminar a ${v.nombre || "este vecino"}?`)) return;
      try {
        await deleteDoc(doc(db, "vecinos", docId));
        mostrarMsg(msgVecinos, "ğŸ—‘ï¸ Vecino eliminado.", "#b91c1c");
      } catch (e) {
        console.error("Error eliminando vecino:", e);
        mostrarMsg(msgVecinos, "âŒ No se pudo eliminar (permisos/reglas).", "#b91c1c", 5000);
      }
    }

    async function editarVecino(docId, v) {
      const nuevoNombre = prompt("Nuevo nombre:", v.nombre || "");
      if (nuevoNombre === null) return;

      const telNuevoRaw = prompt("Nuevo telÃ©fono (solo nÃºmeros):", v.telefono || "");
      if (telNuevoRaw === null) return;

      const telNuevo = normalizarTel(telNuevoRaw);

      if (!nuevoNombre.trim() || !telNuevo.trim()) {
        mostrarMsg(msgVecinos, "âš ï¸ Nombre y telÃ©fono son obligatorios.", "#b91c1c");
        return;
      }
      if (!validarTelAR(telNuevo)) {
        mostrarMsg(msgVecinos, "âš ï¸ TelÃ©fono invÃ¡lido.", "#b91c1c");
        return;
      }

      try {
        // âœ… Caso 1: No cambiÃ³ el telÃ©fono â†’ update normal
        if (telNuevo === (v.telefono || "")) {
          await updateDoc(doc(db, "vecinos", docId), {
            nombre: nuevoNombre.trim(),
            telefono: telNuevo,
            timestamp: serverTimestamp()
          });
          mostrarMsg(msgVecinos, "âœ… Vecino actualizado.", "#166534");
          return;
        }

        // âœ… Caso 2 (tu caso): el ID del doc usa telÃ©fono â†’ hay que â€œmoverâ€ el doc
        // vos creÃ¡s con ID `${productorId}_${telefono}` :contentReference[oaicite:5]{index=5}
        const nuevoId = `${productorId}_${telNuevo}`;

        const batch = writeBatch(db);
        batch.set(doc(db, "vecinos", nuevoId), {
          productorId,
          nombre: nuevoNombre.trim(),
          telefono: telNuevo,
          timestamp: serverTimestamp()
        });
        batch.delete(doc(db, "vecinos", docId));
        await batch.commit();

        mostrarMsg(msgVecinos, "âœ… Vecino actualizado (telÃ©fono cambiado).", "#166534");
      } catch (e) {
        console.error("Error editando vecino:", e);
        mostrarMsg(msgVecinos, "âŒ No se pudo editar (permisos/reglas).", "#b91c1c", 5000);
      }
    }


    /* ============================================================
   âœ… UI: VECINOS SELECCIONABLES PARA ALERTAS
    ============================================================ */

    const listaVecinosAlertas = document.getElementById("listaVecinosAlertas");
    const btnSelTodosVecinos = document.getElementById("btnSelTodosVecinos");
    const btnSelNingunoVecinos = document.getElementById("btnSelNingunoVecinos");

    let vecinosCacheAlertas = []; // [{id, nombre, tel}]

    function renderVecinosParaAlertas() {
      if (!listaVecinosAlertas) return;

      if (!vecinosCacheAlertas.length) {
        listaVecinosAlertas.innerHTML = "<small>No hay vecinos cargados.</small>";
        return;
      }

      listaVecinosAlertas.innerHTML = "";

      vecinosCacheAlertas.forEach((v, i) => {
        const item = document.createElement("div");
        item.className = "item-simple";
        item.style.alignItems = "flex-start";

        item.innerHTML = `
      <label style="display:flex; gap:10px; width:100%; cursor:pointer;">
        <input class="chk-vecino-alerta" type="checkbox" data-tel="${v.tel}" style="margin-top:4px;">
        <div class="item-info">
          <strong>ğŸ¤ ${v.nombre}</strong><br>
          <small>${v.tel}</small>
        </div>
      </label>
    `;

        listaVecinosAlertas.appendChild(item);
      });
    }

    function setTodosVecinosAlertas(valor) {
      document.querySelectorAll(".chk-vecino-alerta").forEach(chk => chk.checked = valor);
    }

    btnSelTodosVecinos?.addEventListener("click", () => setTodosVecinosAlertas(true));
    btnSelNingunoVecinos?.addEventListener("click", () => setTodosVecinosAlertas(false));

    function obtenerTelefonosSeleccionadosDesdeUI() {
      const tels = [];
      document.querySelectorAll(".chk-vecino-alerta").forEach(chk => {
        if (chk.checked) {
          const tel = chk.dataset.tel;
          if (tel) tels.push(tel);
        }
      });
      return tels;
    }

    // âœ… escucha vecinos y llena el selector visual de alertas
    function escucharVecinosParaAlertas() {
      if (!productorId) return;

      const qV = query(collection(db, "vecinos"), where("productorId", "==", productorId));

      onSnapshot(qV, (snap) => {
        vecinosCacheAlertas = [];

        snap.forEach((docSnap) => {
          const v = docSnap.data();
          const tel = normalizarTel(v.telefono);
          if (tel) vecinosCacheAlertas.push({
            id: docSnap.id,
            nombre: v.nombre || "Vecino",
            tel
          });
        });

        renderVecinosParaAlertas();
        // por defecto: no selecciona ninguno (si querÃ©s que seleccione todos, cambialo a true)
        setTodosVecinosAlertas(false);
      }, (err) => {
        console.error("Error vecinos para alertas:", err);
        if (listaVecinosAlertas) listaVecinosAlertas.innerHTML = "<small>âŒ Sin permisos para leer vecinos.</small>";
      });
    }


    /* ============================================================
       ALERTAS (FIRESTORE + ENVÃO POR WHATSAPP) âœ…
       Guarda en colecciÃ³n "alertas" y prepara envÃ­o a vecinos
    ============================================================ */

    const msgAlertas = document.getElementById("msgAlertas");
    const listaAlertas = document.getElementById("listaAlertas");

    async function guardarAlertaFirestore(tipo, descripcion) {
      // guarda la alerta para historial
      return await addDoc(collection(db, "alertas"), {
        productorId,
        tipo,
        descripcion,
        fecha: Date.now(),
        timestamp: serverTimestamp()
      });
    }

    function escucharAlertas() {
      if (!productorId) return;

      const qA = query(
        collection(db, "alertas"),
        where("productorId", "==", productorId)
      );

      onSnapshot(qA, (snap) => {
        listaAlertas.innerHTML = "";
        if (snap.empty) {
          listaAlertas.innerHTML = "<small>No hay alertas enviadas.</small>";
          return;
        }

        snap.forEach((docSnap) => {
          const a = docSnap.data();
          const fechaTxt = a.fecha ? new Date(a.fecha).toLocaleString("es-AR") : "";

          const item = document.createElement("div");
          item.className = "item-simple";
          item.innerHTML = `
        <div class="item-info">
          <strong>ğŸš¨ ${a.tipo || "Alerta"}</strong><br>
          <small>${a.descripcion || ""}</small><br>
          <small>${fechaTxt}</small>
        </div>
      `;

          listaAlertas.appendChild(item);
        });
      });
    }

    async function obtenerTelefonosVecinos() {
      const q = query(collection(db, "vecinos"), where("productorId", "==", productorId));
      const snap = await getDocs(q);
      const tels = [];
      snap.forEach((d) => {
        const tel = normalizarTel(d.data().telefono);
        if (tel) tels.push(tel);
      });
      return tels;
    }

    function abrirWhatsAppLista(telefonos, mensaje) {
      // Evita abrir 30 ventanas de golpe: las abre escalonadas.
      // Aun asÃ­, el navegador puede bloquear si no permitÃ­s popups.
      const msg = encodeURIComponent(mensaje);
      telefonos.forEach((tel, i) => {
        setTimeout(() => {
          window.open(`https://wa.me/${tel}?text=${msg}`, "_blank");
        }, i * 350);
      });
    }

    document.getElementById("btnAgregarVecino").addEventListener("click", agregarVecino);

    document.getElementById("btnEnviarAlerta").addEventListener("click", async () => {
      const tipo = document.getElementById("alertaTipo").value;
      const descripcion = document.getElementById("alertaDescripcion").value.trim();

      if (!descripcion) {
        mostrarMsg(msgAlertas, "âš ï¸ CompletÃ¡ la descripciÃ³n de la alerta.", "#b91c1c");
        return;
      }

      if (!productorId) return;

      try {
        // 1) Guardar alerta en Firestore
        await guardarAlertaFirestore(tipo, descripcion);

        // 2) Traer vecinos y abrir WhatsApp
        const telsVecinos = obtenerTelefonosSeleccionadosDesdeUI();


        if (!telsVecinos.length) {
          mostrarMsg(msgAlertas, "âš ï¸ Alerta guardada, pero no hay vecinos cargados para enviar.", "#b45309", 6000);
          document.getElementById("alertaDescripcion").value = "";
          return;
        }

        const mensaje = `ğŸš¨ ALERTA RED RURAL\nTipo: ${tipo}\nDetalle: ${descripcion}\n\nğŸ“ Esta alerta fue emitida desde el Panel del Productor para advertir una situaciÃ³n en la zona.`;
        abrirWhatsAppLista(telsVecinos, mensaje);

        mostrarMsg(msgAlertas, `âœ… Alerta guardada y lista para enviar a ${telsVecinos.length} vecino(s).`, "#166534", 6000);

        document.getElementById("alertaDescripcion").value = "";
      } catch (e) {
        console.error("Error enviando alerta:", e);
        mostrarMsg(msgAlertas, "âŒ Error al enviar alerta (revisÃ¡ permisos/reglas).", "#b91c1c", 6000);
      }
    });

    function initCalculadora() {
      const ha = document.getElementById("calcHa");
      const kgHa = document.getElementById("calcKgHa");
      const agroUnidad = document.getElementById("agroUnidad");
      const agroTitulo = document.getElementById("agroTitulo");
      const btnTotal = document.getElementById("btnCalcTotal");

      const btnTotalClear = document.getElementById("btnCalcTotalClear");
      const resTotal = document.getElementById("resCalcTotal");

      const nkg = document.getElementById("calcNkg");
      const btnUrea = document.getElementById("btnCalcUrea");
      const btnUreaClear = document.getElementById("btnCalcUreaClear");
      const resUrea = document.getElementById("resCalcUrea");
      // ğŸ„ GanaderÃ­a: MS
      const ganPeso = document.getElementById("ganPeso");
      const ganPorcMS = document.getElementById("ganPorcMS");
      const ganCabezas = document.getElementById("ganCabezas");
      const btnMS = document.getElementById("btnCalcMS");
      const btnMSClear = document.getElementById("btnCalcMSClear");
      const resMS = document.getElementById("resCalcMS");


      // âœ… Guard: si la secciÃ³n no estÃ¡ (por algÃºn error), no rompe
      if (!btnTotal || !btnUrea || !btnMS) return;

      const fmt = (n) => new Intl.NumberFormat("es-AR", { maximumFractionDigits: 2 }).format(n);

      function actualizarUIAgroUnidad() {
        const unidad = agroUnidad?.value || "kg";
        const uHaTxt = unidad === "l" ? "L/ha" : "kg/ha";
        const uTotTxt = unidad === "l" ? "Litros" : "kg";

        if (agroTitulo) agroTitulo.textContent = `ğŸ§ª Fertilizante total (${uHaTxt} â†’ ${uTotTxt})`;

        // cambia el placeholder del input de dosis
        if (kgHa) kgHa.placeholder = `Dosis ${uHaTxt} (ej: ${unidad === "l" ? "8" : "120"})`;
      }
      if (agroUnidad) {
        agroUnidad.addEventListener("change", actualizarUIAgroUnidad);
        actualizarUIAgroUnidad(); // estado inicial apenas carga
      }


      btnTotal.addEventListener("click", () => {
        const haVal = Number(ha.value);
        const kgHaVal = Number(kgHa.value);

        if (!haVal || !kgHaVal || haVal <= 0 || kgHaVal <= 0) {
          resTotal.style.color = "#b91c1c";
          resTotal.textContent = "âš ï¸ CompletÃ¡ hectÃ¡reas y kg/ha con valores mayores a 0.";
          return;
        }

        const total = haVal * kgHaVal;

        const unidad = agroUnidad?.value || "kg"; // por si no existiera, cae en kg
        const uTxt = unidad === "l" ? "Litros" : "kg";
        const uHaTxt = unidad === "l" ? "L/ha" : "kg/ha";

        resTotal.style.color = "#166534";
        resTotal.textContent = `âœ… Total: ${fmt(total)} ${uTxt} (para ${fmt(haVal)} ha a ${fmt(kgHaVal)} ${uHaTxt}).`;

      });

      btnTotalClear.addEventListener("click", () => {
        ha.value = "";
        kgHa.value = "";
        if (agroUnidad) agroUnidad.value = "kg";
        resTotal.textContent = "";

      });

      btnUrea.addEventListener("click", () => {
        const nVal = Number(nkg.value);
        if (!nVal || nVal <= 0) {
          resUrea.style.color = "#b91c1c";
          resUrea.textContent = "âš ï¸ IngresÃ¡ kg de N total (mayor a 0).";
          return;
        }

        const ureaKg = nVal / 0.46;
        resUrea.style.color = "#166534";
        resUrea.textContent = `âœ… Urea necesaria: ${fmt(ureaKg)} kg (para aportar ${fmt(nVal)} kg de N).`;
      });

      btnUreaClear.addEventListener("click", () => {
        nkg.value = "";
        resUrea.textContent = "";
      });

      // âœ… Consumo de Materia Seca
      btnMS.addEventListener("click", () => {
        const pv = Number(ganPeso.value);
        const porc = Number(ganPorcMS.value);
        const cab = Number(ganCabezas.value);

        if (!pv || !porc || !cab || pv <= 0 || porc <= 0 || cab <= 0) {
          resMS.style.color = "#b91c1c";
          resMS.textContent = "âš ï¸ CompletÃ¡ peso, %MS y cabezas con valores mayores a 0.";
          return;
        }

        const msPorCabDia = pv * (porc / 100);
        const totalDia = msPorCabDia * cab;
        const totalMes = totalDia * 30;

        resMS.style.color = "#166534";
        resMS.textContent =
          `âœ… MS por animal/dÃ­a: ${fmt(msPorCabDia)} kg â€¢ Total/dÃ­a: ${fmt(totalDia)} kg â€¢ Total/mes: ${fmt(totalMes)} kg`;
      });

      btnMSClear.addEventListener("click", () => {
        ganPeso.value = "";
        ganPorcMS.value = "";
        ganCabezas.value = "";
        resMS.textContent = "";
      });

    }

    function initClima() {
      const inpLugar = document.getElementById("climaLugar");
      const btnBuscar = document.getElementById("btnClimaBuscar");
      const btnGPS = document.getElementById("btnClimaGPS");
      const msg = document.getElementById("msgClima");

      const actualBody = document.getElementById("climaActualBody");
      const alertasBody = document.getElementById("climaAlertasBody");
      const diasBody = document.getElementById("clima7diasBody");

      if (!btnBuscar || !btnGPS || !msg || !actualBody || !alertasBody || !diasBody) return;

      const setMsg = (t, c = "#14532d") => { msg.textContent = t; msg.style.color = c; };

      const fmt = (n) => new Intl.NumberFormat("es-AR", { maximumFractionDigits: 1 }).format(n);

      // âœ… Open-Meteo Geocoding: https://geocoding-api.open-meteo.com/v1/search (name=...) :contentReference[oaicite:0]{index=0}
      async function geocodeLugar(texto) {
        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(texto)}&count=5&language=es&format=json`;
        const r = await fetch(url);
        const data = await r.json();
        const first = data?.results?.[0];
        if (!first) return null;
        return {
          name: `${first.name}${first.admin1 ? ", " + first.admin1 : ""}${first.country ? ", " + first.country : ""}`,
          lat: first.latitude,
          lon: first.longitude,
          tz: first.timezone
        };
      }

      // âœ… Forecast API base: https://api.open-meteo.com/v1/forecast ... :contentReference[oaicite:1]{index=1}
      async function pedirPronostico(lat, lon, timezone = "auto") {
        const url =
          `https://api.open-meteo.com/v1/forecast` +
          `?latitude=${encodeURIComponent(lat)}` +
          `&longitude=${encodeURIComponent(lon)}` +
          `&timezone=${encodeURIComponent(timezone)}` +
          `&current=temperature_2m,wind_speed_10m,precipitation,weather_code` +
          `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,wind_speed_10m_max,weather_code` +
          `&forecast_days=7`;

        const r = await fetch(url);
        if (!r.ok) throw new Error("No se pudo obtener pronÃ³stico");
        return await r.json();
      }


      function codeToText(code) {
        // Mapa simple (podemos ampliarlo despuÃ©s)
        const m = {
          0: "Despejado",
          1: "Mayormente despejado",
          2: "Parcialmente nublado",
          3: "Nublado",
          45: "Niebla",
          48: "Niebla con escarcha",
          51: "Llovizna leve",
          53: "Llovizna",
          55: "Llovizna intensa",
          61: "Lluvia leve",
          63: "Lluvia",
          65: "Lluvia intensa",
          71: "Nieve leve",
          73: "Nieve",
          75: "Nieve intensa",
          95: "Tormenta"
        };
        return m[code] ?? `CÃ³digo ${code}`;
      }

      function render(data, tituloLugar) {
        // ACTUAL
        const c = data.current;
        if (!c) {
          actualBody.innerHTML = "No hay datos actuales.";
          return;
        }

        const t = c.temperature_2m;
        const viento = c.wind_speed_10m;
        const precip = c.precipitation;
        const wc = c.weather_code;

        actualBody.innerHTML = `
      <div><b>ğŸ“ ${tituloLugar}</b></div>
      <div>ğŸŒ¡ï¸ Temp: <b>${fmt(t)}Â°C</b></div>
      <div>ğŸ’¨ Viento: <b>${fmt(viento)} km/h</b></div>
      <div>ğŸŒ§ï¸ Precip: <b>${fmt(precip)} mm</b></div>
      <div>ğŸ§¾ Estado: <b>${codeToText(wc)}</b></div>
    `;

        // 7 DÃAS
        const d = data.daily;
        if (!d?.time?.length) {
          diasBody.innerHTML = "No hay pronÃ³stico diario.";
          return;
        }

        const rows = d.time.map((date, i) => {
          const tmin = d.temperature_2m_min?.[i];
          const tmax = d.temperature_2m_max?.[i];
          const p = d.precipitation_sum?.[i];
          const w = d.wind_speed_10m_max?.[i];
          const wcD = d.weather_code?.[i];

          const f = new Date(date + "T00:00:00");
          const dia = f.toLocaleDateString("es-AR", { weekday: "short", day: "2-digit", month: "2-digit" });

          return `
        <div class="item-simple" style="gap:14px;">
          <div class="item-info">
            <strong>${dia}</strong><br>
            <small>${codeToText(wcD)}</small><br>
            <small>ğŸŒ¡ï¸ ${fmt(tmin)}Â° / ${fmt(tmax)}Â° â€¢ ğŸŒ§ï¸ ${fmt(p)} mm â€¢ ğŸ’¨ ${fmt(w)} km/h</small>
          </div>
        </div>
      `;
        }).join("");

        diasBody.innerHTML = rows;

        // ALERTAS (reglas simples)
        const alerts = [];
        const hoyP = d.precipitation_sum?.[0] ?? 0;
        const hoyMin = d.temperature_2m_min?.[0];
        const hoyV = d.wind_speed_10m_max?.[0] ?? 0;

        if (hoyP >= 20) alerts.push("ğŸŒ§ï¸ Lluvia fuerte hoy (â‰¥ 20 mm): planificÃ¡ labores / caminos.");
        if (hoyMin != null && hoyMin <= 0) alerts.push("â„ï¸ Riesgo de helada (mÃ­n â‰¤ 0Â°C).");
        if (hoyV >= 40) alerts.push("ğŸ’¨ Viento fuerte (â‰¥ 40 km/h): ojo fumigaciÃ³n / incendios.");

        alertasBody.innerHTML = alerts.length
          ? `<ul style="margin:0; padding-left:18px;">${alerts.map(a => `<li>${a}</li>`).join("")}</ul>`
          : "âœ… Sin alertas destacadas (segÃºn reglas simples).";
      }

      async function usarGPS() {
        try {
          setMsg("ğŸ“¡ Buscando tu ubicaciÃ³n...", "#14532d");
          const pos = await pedirUbicacionActual();
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          const data = await pedirPronostico(lat, lon, "auto");
          render(data, "Mi ubicaciÃ³n");
          setMsg("âœ… Clima actualizado (GPS).", "#166534");
        } catch (e) {
          console.error(e);
          setMsg("âŒ No pude obtener el clima por GPS. RevisÃ¡ permisos/ubicaciÃ³n.", "#b91c1c");
        }
      }

      async function buscarLugar() {
        const texto = (inpLugar.value || "").trim();
        if (!texto) {
          setMsg("âš ï¸ EscribÃ­ un lugar (ej: Gualeguay, Entre RÃ­os).", "#b91c1c");
          return;
        }

        try {
          setMsg("ğŸ” Buscando lugar...", "#14532d");
          const loc = await geocodeLugar(texto);
          if (!loc) {
            setMsg("âŒ No encontrÃ© ese lugar. ProbÃ¡ agregando provincia/paÃ­s.", "#b91c1c");
            return;
          }
          setMsg("ğŸ“¡ Consultando pronÃ³stico...", "#14532d");
          const data = await pedirPronostico(loc.lat, loc.lon, loc.tz || "auto");
          render(data, loc.name);
          setMsg("âœ… Clima actualizado.", "#166534");
        } catch (e) {
          console.error(e);
          setMsg("âŒ Error consultando clima. ProbÃ¡ de nuevo.", "#b91c1c");
        }
      }

      btnBuscar.addEventListener("click", buscarLugar);
      btnGPS.addEventListener("click", usarGPS);

      // carga inicial: si querÃ©s que arranque con GPS, descomentÃ¡:
      // usarGPS();
    }

    function aplicarBloqueosPorPlan() {
      const esFree = planActual !== "pro";

      // ======================
      // NAV PRINCIPAL
      // ======================
      const navCamiones = document.querySelector('[data-target="sec-camiones"]');
      const navAlertas = document.querySelector('[data-target="sec-alertas"]');

      if (navCamiones) navCamiones.style.display = esFree ? "none" : "flex";
      if (navAlertas) navAlertas.style.display = esFree ? "none" : "flex";

      // ======================
      // ACCESOS RÃPIDOS HOY
      // ======================
      const btnHoyCamiones = document.getElementById("btnHoyIrCamiones");
      const btnHoyAlertas = document.getElementById("btnHoyIrAlertas");

      if (btnHoyCamiones) btnHoyCamiones.style.display = esFree ? "none" : "inline-flex";
      if (btnHoyAlertas) btnHoyAlertas.style.display = esFree ? "none" : "inline-flex";

      // ======================
      // SECCIONES (seguridad extra)
      // ======================
      const secCamiones = document.getElementById("sec-camiones");
      const secAlertas = document.getElementById("sec-alertas");

      if (secCamiones && esFree) secCamiones.classList.add("hidden");
      if (secAlertas && esFree) secAlertas.classList.add("hidden");
    }
  </script>
</body>

</html>