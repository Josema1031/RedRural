<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Empleado â€” RuralControl</title>
  <style>
    body { margin:0; padding:18px; font-family:Arial,sans-serif; background:#f0f2f3 }
    .top { display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap }
    .top h1 { margin:0; font-size:20px }
    .btn { border:0; border-radius:10px; padding:10px 12px; font-weight:800; cursor:pointer }
    .btn-out { background:#111827; color:#fff }
    .wrap { max-width:980px; margin:0 auto }
    .grid { display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px }
    @media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr } }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow:0 10px 25px rgba(0,0,0,.10) }
    .item { background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin-top:10px }
    .muted { color:#6b7280; font-size:13px }
    .actions { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn-ok { background:#14532d; color:#fff; border:0; border-radius:10px; padding:8px 10px; font-weight:800; cursor:pointer; }
    .btn-ok[disabled]{ opacity:.6; cursor:not-allowed; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h1>ðŸ“‹ Panel del Empleado</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <a class="btn btn-out" href="../index.html" id="btnSalir"
          style="text-decoration:none;display:inline-block">â¬… Salir</a>
      </div>
    </div>

    <p class="muted" id="sub"></p>

    <div class="grid">
      <div class="card">
        <h2 style="margin:0 0 8px">âœ… Tareas asignadas</h2>
        <div id="listaTareas" class="muted">Cargando...</div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px">ðŸ“£ Alertas del Productor</h2>
        <div id="listaAlertas" class="muted">Cargando...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "../firebase-init.js";
    import { onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, query, where, onSnapshot, orderBy,
      doc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const empleadoDni = (localStorage.getItem("empleadoDni") || "").trim();
    const productorId = (localStorage.getItem("productorId") || "").trim();

    const sub = document.getElementById("sub");
    const listaTareas = document.getElementById("listaTareas");
    const listaAlertas = document.getElementById("listaAlertas");

    sub.textContent = empleadoDni ? `SesiÃ³n: DNI ${empleadoDni}` : "Sin sesiÃ³n activa.";

    // Salida limpia
    document.getElementById("btnSalir").addEventListener("click", () => {
      localStorage.removeItem("empleadoDni");
      localStorage.removeItem("empleadoDocId");
      localStorage.removeItem("productorId");
    });

    if (!empleadoDni || !productorId) {
      listaTareas.textContent = "TenÃ©s que iniciar sesiÃ³n.";
      listaAlertas.textContent = "TenÃ©s que iniciar sesiÃ³n.";
      // si querÃ©s: location.href = "./login.html";
    } else {
      // âœ… Asegurar auth anÃ³nimo (necesario para que Firestore reglas permitan leer)
      const asegurarAuth = async () => {
        if (auth.currentUser) return;
        await signInAnonymously(auth);
      };

      // âœ… Cuando ya hay auth, reciÃ©n ahÃ­ escuchamos Firestore
      onAuthStateChanged(auth, async (user) => {
        try {
          if (!user) await asegurarAuth();
          iniciarListeners();
        } catch (e) {
          console.error("Auth empleado:", e);
          listaTareas.textContent = "No se pudo iniciar sesiÃ³n (auth).";
          listaAlertas.textContent = "No se pudo iniciar sesiÃ³n (auth).";
        }
      });

      function iniciarListeners() {
        // âœ… TAREAS: filtramos por productorId + empleadoId (dni) y orden por timestamp
        const qT = query(
          collection(db, "tareas"),
          where("productorId", "==", productorId),
          where("empleadoId", "==", empleadoDni),
          orderBy("timestamp", "desc")
        );

        onSnapshot(qT, (snap) => {
          listaTareas.innerHTML = "";

          if (snap.empty) {
            listaTareas.textContent = "No hay tareas asignadas.";
            return;
          }

          snap.forEach((d) => {
            const t = d.data();
            const div = document.createElement("div");
            div.className = "item";

            const estadoTxt = t.completada ? "âœ… Completada" : "ðŸ•’ Pendiente";

            div.innerHTML = `
              <div><b>ðŸ“Œ ${t.texto ?? "(sin texto)"}</b></div>
              <div class="muted">
                ${t.categoria ?? "Sin categorÃ­a"} â€¢ ${t.prioridad ?? ""} â€¢ ${estadoTxt}
              </div>
              ${t.completada ? "" : `
                <div class="actions">
                  <button class="btn-ok">âœ… Marcar realizada</button>
                </div>
              `}
            `;

            // ðŸ‘‰ SOLO si estÃ¡ pendiente, habilitamos botÃ³n
            if (!t.completada) {
              const btn = div.querySelector(".btn-ok");
              btn.addEventListener("click", async () => {
                try {
                  btn.disabled = true;
                  btn.textContent = "Guardando...";

                  await updateDoc(doc(db, "tareas", d.id), {
                    completada: true,
                    realizadaEn: serverTimestamp()
                  });

                } catch (e) {
                  console.error("No se pudo completar:", e);
                  btn.disabled = false;
                  btn.textContent = "âœ… Marcar realizada";
                  alert("No se pudo marcar como realizada. RevisÃ¡ permisos/reglas.");
                }
              });
            }

            listaTareas.appendChild(div);
          });

        }, (err) => {
          console.error("Snapshot tareas:", err);
          listaTareas.textContent = "Error cargando tareas (reglas/Ã­ndices).";
        });

        // âœ… ALERTAS: por ahora mostramos alertas del productor (si existen)
        // (si tu estructura tiene campo 'para': 'todos' o DNI, filtramos en cliente)
        const qA = query(
          collection(db, "alertas"),
          where("productorId", "==", productorId),
          orderBy("timestamp", "desc")
        );

        onSnapshot(qA, (snap) => {
          listaAlertas.innerHTML = "";

          if (snap.empty) {
            listaAlertas.textContent = "Sin alertas.";
            return;
          }

          let cant = 0;
          snap.forEach((d) => {
            const a = d.data();
            const para = (a.para || "todos").toString().trim(); // "todos" o DNI

            if (para !== "todos" && para !== empleadoDni) return;

            cant++;
            const div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
              <div><b>ðŸš¨ ${a.tipo ?? "Alerta"}</b></div>
              <div class="muted">${a.descripcion ?? ""}</div>
            `;
            listaAlertas.appendChild(div);
          });

          if (cant === 0) listaAlertas.textContent = "Sin alertas.";
        }, (err) => {
          console.error("Snapshot alertas:", err);
          listaAlertas.textContent = "Error cargando alertas (reglas/Ã­ndices).";
        });
      }
    }
  </script>
</body>

</html>
