<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Empleado ‚Äî RuralControl</title>
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#14532d">
  <link rel="apple-touch-icon" href="../img/logo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    body {
      margin: 0;
      padding: 18px;
      font-family: Arial, sans-serif;
      background: #f0f2f3
    }

    .top {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .top h1 {
      margin: 0;
      font-size: 20px
    }

    .btn {
      border: 0;
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 800;
      cursor: pointer
    }

    .btn-out {
      background: #111827;
      color: #fff
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px
    }

    @media(min-width:900px) {
      .grid {
        grid-template-columns: 1fr 1fr
      }
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, .10)
    }

    .item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px
    }

    .muted {
      color: #6b7280;
      font-size: 13px
    }

    .actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-ok {
      background: #14532d;
      color: #fff;
      border: 0;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 800;
      cursor: pointer;
    }

    .btn-ok[disabled] {
      opacity: .6;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h1>üìã Panel del Empleado</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <a class="btn btn-out" href="../index.html" id="btnSalir" style="text-decoration:none;display:inline-block">‚¨Ö
          Salir</a>
      </div>
    </div>

    <p class="muted" id="sub"></p>

    <div class="grid">
      <div class="card">
        <h2 style="margin:0 0 8px">‚úÖ Tareas asignadas</h2>
        <div id="listaTareas" class="muted">Cargando...</div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px">üì£ Alertas del Productor</h2>
        <div id="listaAlertas" class="muted">Cargando...</div>
      </div>

      <!-- ‚úÖ NUEVO: Monitoreo Cami√≥n -->
      <div class="card">
        <h2 style="margin:0 0 8px">üöö Monitoreo del cami√≥n</h2>
        <div class="muted" style="margin-bottom:10px">
          Envi√° tu ubicaci√≥n en tiempo real al Productor.
        </div>

        <label style="display:block;font-size:.85rem;margin-top:8px;margin-bottom:4px;color:#374151">
          ID / Patente del cami√≥n
        </label>
        <input id="camionId" placeholder="Ej: ABC123 o CAMION-1"
          style="width:100%;padding:10px;border-radius:10px;border:1px solid #e5e7eb" />

        <div class="actions" style="margin-top:10px">
          <button class="btn-ok" id="btnStartTrack">‚ñ∂ Iniciar</button>
          <button class="btn" id="btnStopTrack"
            style="background:#7f1d1d;color:#fff;border-radius:10px;padding:8px 10px;font-weight:800" disabled>
            ‚ñ† Detener
          </button>
        </div>

        <div id="msgTrack" class="muted" style="margin-top:10px">Estado: detenido</div>
      </div>
    </div>

  </div>

  <script type="module">
    import { auth, db } from "../firebase-init.js";
    import { onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, query, where, onSnapshot, orderBy,
      doc, updateDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


    const empleadoDni = (localStorage.getItem("empleadoDni") || "").trim();
    const productorId = (localStorage.getItem("productorId") || "").trim();

    const sub = document.getElementById("sub");
    const listaTareas = document.getElementById("listaTareas");
    const listaAlertas = document.getElementById("listaAlertas");

    sub.textContent = empleadoDni ? `Sesi√≥n: DNI ${empleadoDni}` : "Sin sesi√≥n activa.";

    // Salida limpia
    document.getElementById("btnSalir").addEventListener("click", (e) => {
      const activo = localStorage.getItem("trackingActivo") === "1";
      if (activo) {
        const ok = confirm("El monitoreo est√° INICIADO. Si sal√≠s, el GPS puede cortarse. ¬øQuer√©s salir igual?");
        if (!ok) {
          e.preventDefault();
          return;
        }
        // ‚úÖ NO borramos localStorage, as√≠ al volver reanuda
        return;
      }

      // salida limpia normal
      localStorage.removeItem("empleadoDni");
      localStorage.removeItem("empleadoDocId");
      localStorage.removeItem("productorId");
    });


    if (!empleadoDni || !productorId) {
      listaTareas.textContent = "Ten√©s que iniciar sesi√≥n.";
      listaAlertas.textContent = "Ten√©s que iniciar sesi√≥n.";
      // si quer√©s: location.href = "./login.html";
    } else {
      // ‚úÖ Asegurar auth an√≥nimo (necesario para que Firestore reglas permitan leer)
      const asegurarAuth = async () => {
        if (auth.currentUser) return;
        await signInAnonymously(auth);
      };

      // ‚úÖ Cuando ya hay auth, reci√©n ah√≠ escuchamos Firestore
      onAuthStateChanged(auth, async (user) => {
        try {
          if (!user) await asegurarAuth();
          iniciarListeners();
        } catch (e) {
          console.error("Auth empleado:", e);
          listaTareas.textContent = "No se pudo iniciar sesi√≥n (auth).";
          listaAlertas.textContent = "No se pudo iniciar sesi√≥n (auth).";
        }
      });

      function iniciarListeners() {
        // ‚úÖ TAREAS: filtramos por productorId + empleadoId (dni) y orden por timestamp
        const qT = query(
          collection(db, "tareas"),
          where("productorId", "==", productorId),
          where("empleadoId", "==", empleadoDni),
          orderBy("timestamp", "desc")
        );

        onSnapshot(qT, (snap) => {
          listaTareas.innerHTML = "";

          if (snap.empty) {
            listaTareas.textContent = "No hay tareas asignadas.";
            return;
          }

          snap.forEach((d) => {
            const t = d.data();
            const div = document.createElement("div");
            div.className = "item";

            const estadoTxt = t.completada ? "‚úÖ Completada" : "üïí Pendiente";

            div.innerHTML = `
              <div><b>üìå ${t.texto ?? "(sin texto)"}</b></div>
              <div class="muted">
                ${t.categoria ?? "Sin categor√≠a"} ‚Ä¢ ${t.prioridad ?? ""} ‚Ä¢ ${estadoTxt}
              </div>
              ${t.completada ? "" : `
                <div class="actions">
                  <button class="btn-ok">‚úÖ Marcar realizada</button>
                </div>
              `}
            `;

            // üëâ SOLO si est√° pendiente, habilitamos bot√≥n
            if (!t.completada) {
              const btn = div.querySelector(".btn-ok");
              btn.addEventListener("click", async () => {
                try {
                  btn.disabled = true;
                  btn.textContent = "Guardando...";

                  await updateDoc(doc(db, "tareas", d.id), {
                    completada: true,
                    realizadaEn: serverTimestamp()
                  });

                } catch (e) {
                  console.error("No se pudo completar:", e);
                  btn.disabled = false;
                  btn.textContent = "‚úÖ Marcar realizada";
                  alert("No se pudo marcar como realizada. Revis√° permisos/reglas.");
                }
              });
            }

            listaTareas.appendChild(div);
          });

        }, (err) => {
          console.error("Snapshot tareas:", err);
          listaTareas.textContent = "Error cargando tareas (reglas/√≠ndices).";
        });

        // ‚úÖ ALERTAS: por ahora mostramos alertas del productor (si existen)
        // (si tu estructura tiene campo 'para': 'todos' o DNI, filtramos en cliente)
        const qA = query(
          collection(db, "alertas"),
          where("productorId", "==", productorId),
          orderBy("timestamp", "desc")
        );

        onSnapshot(qA, (snap) => {
          listaAlertas.innerHTML = "";

          if (snap.empty) {
            listaAlertas.textContent = "Sin alertas.";
            return;
          }

          let cant = 0;
          snap.forEach((d) => {
            const a = d.data();
            const para = (a.para || "todos").toString().trim(); // "todos" o DNI

            if (para !== "todos" && para !== empleadoDni) return;

            cant++;
            const div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
              <div><b>üö® ${a.tipo ?? "Alerta"}</b></div>
              <div class="muted">${a.descripcion ?? ""}</div>
            `;
            listaAlertas.appendChild(div);
          });

          if (cant === 0) listaAlertas.textContent = "Sin alertas.";
        }, (err) => {
          console.error("Snapshot alertas:", err);
          listaAlertas.textContent = "Error cargando alertas (reglas/√≠ndices).";
        });

        // ===============================
        // üöö TRACKING CAMI√ìN ‚Äî OPCI√ìN 2
        // - No se detiene por salir.
        // - Reanuda solo si estaba activo.
        // - WakeLock para evitar que el celular duerma.
        // ===============================
        let watchId = null;

        const camionIdEl = document.getElementById("camionId");
        const btnStartTrack = document.getElementById("btnStartTrack");
        const btnStopTrack = document.getElementById("btnStopTrack");
        const msgTrack = document.getElementById("msgTrack");

        const TRACK_KEY = "trackingActivo";
        const TRACK_CAMION_KEY = "trackingCamionId";

        function setMsg(t, ok = true) {
          msgTrack.textContent = t;
          msgTrack.style.color = ok ? "#14532d" : "#b91c1c";
        }

        async function upsertCamion(camionId, payload) {
          await setDoc(doc(db, "camiones", camionId), payload, { merge: true });
        }

        // --------------------
        // Wake Lock
        // --------------------
        let wakeLock = null;

        async function activarWakeLock() {
          try {
            if ("wakeLock" in navigator) {
              wakeLock = await navigator.wakeLock.request("screen");
              console.log("‚úÖ WakeLock activo");
            }
          } catch (e) {
            console.warn("WakeLock no disponible:", e);
          }
        }

        async function desactivarWakeLock() {
          try {
            if (wakeLock) {
              await wakeLock.release();
              wakeLock = null;
              console.log("‚èπ WakeLock liberado");
            }
          } catch { }
        }

        // Si vuelve a primer plano y estaba activo, re-pedir WakeLock
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible" && localStorage.getItem(TRACK_KEY) === "1") {
            activarWakeLock();
          }
        });

        // --------------------
        // Start
        // --------------------
        btnStartTrack.addEventListener("click", async () => {
          const camionId = (camionIdEl.value || "").trim();
          if (!camionId) return setMsg("‚ö†Ô∏è Ingres√° el ID/patente del cami√≥n.", false);

          if (!("geolocation" in navigator)) {
            return setMsg("‚ùå Este dispositivo no tiene geolocalizaci√≥n.", false);
          }

          // Persistir estado para reanudar
          localStorage.setItem(TRACK_KEY, "1");
          localStorage.setItem(TRACK_CAMION_KEY, camionId);
          await activarWakeLock();

          // Evitar doble tracking
          if (watchId) navigator.geolocation.clearWatch(watchId);

          btnStartTrack.disabled = true;
          btnStopTrack.disabled = false;

          setMsg("üì° Iniciando monitoreo...");

          // Primer ping
          await upsertCamion(camionId, {
            productorId,
            camionId,
            empleadoDni,
            online: true,
            updatedAt: serverTimestamp(),
            lastSeen: Date.now()
          });

          watchId = navigator.geolocation.watchPosition(
            async (pos) => {
              const lat = pos.coords.latitude;
              const lng = pos.coords.longitude;

              await upsertCamion(camionId, {
                productorId,
                camionId,
                empleadoDni,
                lat,
                lng,
                accuracy: Math.round(pos.coords.accuracy || 0),
                speed: pos.coords.speed ?? null,
                heading: pos.coords.heading ?? null,
                online: true,
                updatedAt: serverTimestamp(),
                lastSeen: Date.now()
              });

              setMsg(`‚úÖ Enviando ubicaci√≥n‚Ä¶ (${lat.toFixed(5)}, ${lng.toFixed(5)})`);
            },
            (err) => {
              console.error("GPS watch error:", err);

              let msg = "‚ùå Error de GPS. Activ√° permisos/ubicaci√≥n del celular.";
              if (err?.code === 1) msg = "‚ùå Permiso denegado. Activ√° ubicaci√≥n para este sitio.";
              if (err?.code === 2) msg = "‚ùå No se pudo obtener se√±al GPS. Prob√° al aire libre.";
              if (err?.code === 3) msg = "‚ùå Timeout GPS. Reintent√° o movete a un lugar con mejor se√±al.";

              setMsg(msg, false);
              btnStartTrack.disabled = false;
              btnStopTrack.disabled = true;
            }
            ,
            {
              enableHighAccuracy: true,
              timeout: 20000,      // m√°s tiempo
              maximumAge: 10000    // acept√° cache 10s
            }

          );
        });

        // --------------------
        // Stop (√∫nica forma de ‚Äúdetener‚Äù real)
        // --------------------
        btnStopTrack.addEventListener("click", async () => {
          const camionId = (camionIdEl.value || "").trim();

          localStorage.removeItem(TRACK_KEY);
          localStorage.removeItem(TRACK_CAMION_KEY);
          await desactivarWakeLock();

          if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
          }

          btnStartTrack.disabled = false;
          btnStopTrack.disabled = true;

          setMsg("‚èπ Monitoreo detenido.");

          if (camionId) {
            try {
              await updateDoc(doc(db, "camiones", camionId), {
                online: false,
                updatedAt: serverTimestamp(),
                lastSeen: Date.now()
              });
            } catch (e) {
              console.warn("No pude marcar offline:", e);
            }
          }
        });

        // --------------------
        // Auto-reanudar si estaba activo
        // --------------------
        const estabaActivo = localStorage.getItem(TRACK_KEY) === "1";
        const camionGuardado = (localStorage.getItem(TRACK_CAMION_KEY) || "").trim();

        if (estabaActivo && camionGuardado) {
          camionIdEl.value = camionGuardado;
          btnStartTrack.click();
        }



      }
    }
  </script>
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("../service-worker.js")
          .then(() => console.log("‚úÖ SW registrado (empleado)"))
          .catch((e) => console.warn("‚ùå SW error (empleado):", e));
      });
    }
  </script>

</body>

</html>