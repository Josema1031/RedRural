<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Red Rural ‚Äî Caminos p√∫blicos</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --b:#e5e7eb;
      --green:#16a34a;
      --yellow:#eab308;
      --red:#dc2626;
      --brand1:#0f766e;
      --brand2:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      background:#14532D;
      color:#fff;
      padding:14px 16px;
    }
    header h1{margin:0;font-size: 18px;text-align: center;}
    header p{margin:6px 0 0;opacity:.95;font-size:.95rem}

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:12px;
      display:grid;
      gap:12px;
    }

    .grid{
      display:grid;
      gap:12px;
    }
    @media(min-width:900px){
      .grid{grid-template-columns:360px 1fr;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--b);
      border-radius:14px;
      padding:12px;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
    }

    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      border:1px solid var(--b);
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-size:.85rem;
      color:#374151;
      user-select:none;
    }
    .chip.activo{background:#111827;color:#fff;border-color:#111827}

    .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; color:var(--muted); font-size:.85rem}
    .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px}
    .dot.g{background:var(--green)}
    .dot.y{background:var(--yellow)}
    .dot.r{background:var(--red)}

    #map{
      min-height:420px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--b);
    }

    .muted{color:var(--muted); font-size:.9rem}
    .count{margin-top:10px; font-weight:800}
    .list{margin-top:10px; max-height:260px; overflow:auto; border-top:1px solid var(--b); padding-top:10px}
    .item{
      border:1px solid var(--b);
      border-radius:12px;
      padding:10px;
      background:#fff;
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .badge{
      padding:4px 10px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:900;
      color:#fff;
      height:fit-content;
      white-space:nowrap;
    }
    .b-g{background:var(--green)}
    .b-y{background:var(--yellow); color:#111827}
    .b-r{background:var(--red)}
    a.btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--b);
      text-decoration:none;
      color:#111827;
      background:#e5e7eb;
      font-weight:800;
      margin-top:10px;
    }
  </style>
</head>

<body>
  <header>
    <h1>üõ£Ô∏è Red Rural ‚Äî Caminos p√∫blicos</h1>
    <p>Estado de caminos(en tiempo real).</p>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:900;font-size:1.05rem">Filtros</div>
            <div class="muted">Mostrando reportes p√∫blicos</div>
          </div>
          <a class="btn" href="../">üè† Volver</a>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="chip activo" id="fTodos">Todos</div>
          <div class="chip" id="fTrans">üü¢ Transitable</div>
          <div class="chip" id="fComp">üü° Complicado</div>
          <div class="chip" id="fIntra">üî¥ Intransitable</div>
        </div>

        <div class="legend">
          <span><span class="dot g"></span>Transitable</span>
          <span><span class="dot y"></span>Complicado</span>
          <span><span class="dot r"></span>Intransitable</span>
        </div>

        <div class="count" id="count">Cargando‚Ä¶</div>
        <div class="list" id="lista"></div>

        <div class="muted" style="margin-top:10px">
          Tip: toc√° un √≠tem para ‚Äúvolar‚Äù al punto/tramo en el mapa.
        </div>
      </div>

      <div class="card" style="padding:0">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script type="module">
    // ‚úÖ Ajust√° la ruta si tu firebase-init est√° en otro lugar
    import { db } from "../firebase-init.js";
    import {
      collection, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ====== MAPA ======
    const map = L.map("map").setView([-33.15, -59.33], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

    const capaPuntos = L.layerGroup().addTo(map);
    const capaTramos = L.layerGroup().addTo(map);

    const colores = {
      transitable: "#16a34a",
      complicado: "#eab308",
      intransitable: "#dc2626"
    };

    function badgeClass(estado){
      if(estado === "transitable") return "b-g";
      if(estado === "complicado") return "b-y";
      return "b-r";
    }

    function labelEstado(estado){
      return estado === "transitable" ? "üü¢ Transitable"
        : estado === "complicado" ? "üü° Complicado"
        : "üî¥ Intransitable";
    }

    // ====== UI ======
    const lista = document.getElementById("lista");
    const count = document.getElementById("count");

    const chips = {
      todos: document.getElementById("fTodos"),
      transitable: document.getElementById("fTrans"),
      complicado: document.getElementById("fComp"),
      intransitable: document.getElementById("fIntra"),
    };

    let filtro = "todos";
    function setChipActivo(key){
      Object.values(chips).forEach(c => c.classList.remove("activo"));
      chips[key].classList.add("activo");
    }

    chips.todos.onclick = () => { filtro = "todos"; setChipActivo("todos"); render(); };
    chips.transitable.onclick = () => { filtro = "transitable"; setChipActivo("transitable"); render(); };
    chips.complicado.onclick = () => { filtro = "complicado"; setChipActivo("complicado"); render(); };
    chips.intransitable.onclick = () => { filtro = "intransitable"; setChipActivo("intransitable"); render(); };

    // ====== DATA ======
    let docs = []; // {id, ...data}
    const flyTargets = new Map(); // id -> {type, latlngs}

    function limpiar(){
      capaPuntos.clearLayers();
      capaTramos.clearLayers();
      lista.innerHTML = "";
      flyTargets.clear();
    }

    function render(){
      limpiar();

      const filtrados = docs.filter(d => filtro === "todos" ? true : d.estado === filtro);

      // pintar en mapa + lista
      filtrados.forEach(d => {
        const estado = d.estado || "complicado";
        const color = colores[estado] || "#6b7280";
        const alias = (d.alias || "").trim();
        const fecha = d.fecha ? new Date(d.fecha).toLocaleString("es-AR") : "";

        if(d.tipo === "punto" && typeof d.lat === "number" && typeof d.lng === "number"){
          const m = L.circleMarker([d.lat, d.lng], {
            radius: 8, weight: 2, color: "#111827",
            fillColor: color, fillOpacity: .95
          }).addTo(capaPuntos);

          const titulo = alias ? `üìç ${alias}` : labelEstado(estado);
          m.bindTooltip(titulo, { direction:"top", offset:[0,-10], opacity:.9 });

          m.bindPopup(`
            <b>${titulo}</b><br>
            <b>${labelEstado(estado)}</b><br>
            <small>${fecha}</small><br>
            <small>${d.productorId ? "Prod: " + d.productorId : ""}</small>
          `);

          flyTargets.set(d.id, { type:"punto", latlngs:[[d.lat,d.lng]] });
        }

        if(d.tipo === "tramo" && Array.isArray(d.puntos) && d.puntos.length >= 2){
          const poly = L.polyline(d.puntos, {
            color, weight: estado === "intransitable" ? 6 : estado === "complicado" ? 5 : 4,
            opacity: .9, dashArray: estado === "complicado" ? "6,4" : null
          }).addTo(capaTramos);

          const titulo = alias ? `üõ£Ô∏è ${alias}` : labelEstado(estado);
          poly.bindTooltip(titulo, { direction:"center", opacity:.9 });

          poly.bindPopup(`
            <b>${titulo}</b><br>
            <b>${labelEstado(estado)}</b><br>
            <small>${fecha}</small>
          `);

          flyTargets.set(d.id, { type:"tramo", latlngs:d.puntos });
        }

        // lista
        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
          <div>
            <div style="font-weight:900">${alias ? alias : (d.tipo === "tramo" ? "Tramo sin nombre" : "Punto sin nombre")}</div>
            <div class="muted">${d.tipo === "tramo" ? "üõ£Ô∏è Tramo" : "üìç Punto"} ‚Ä¢ ${fecha}</div>
          </div>
          <div class="badge ${badgeClass(estado)}">${estado}</div>
        `;
        item.style.cursor = "pointer";
        item.onclick = () => {
          const t = flyTargets.get(d.id);
          if(!t) return;

          if(t.type === "punto"){
            map.setView(t.latlngs[0], 16, { animate:true });
          } else {
            const bounds = L.latLngBounds(t.latlngs.map(p => L.latLng(p[0], p[1])));
            map.fitBounds(bounds, { padding:[30,30] });
          }
        };

        lista.appendChild(item);
      });

      count.textContent = `Reportes visibles: ${filtrados.length}`;
    }

    // ‚úÖ lectura p√∫blica en tiempo real
    const qCaminos = query(collection(db, "caminos"), orderBy("fecha", "desc"));

    onSnapshot(qCaminos, (snap) => {
      docs = [];
      snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
      render();
    }, (err) => {
      console.error("Caminos p√∫blicos:", err);
      count.textContent = "Error leyendo caminos (reglas/permisos).";
      lista.innerHTML = "<div class='muted'>Revis√° reglas de Firestore para permitir lectura p√∫blica.</div>";
    });
  </script>
</body>
</html>
